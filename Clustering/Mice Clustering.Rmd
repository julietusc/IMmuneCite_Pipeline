---
title: "Mice Clustering"
author: "Sarah Bangerth"
date: "2023-10-31"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

setwd('/users/sarahbangerth/Desktop/IMC/Adult IMC Output')

## Libraries
library(imcRtools)
library(cytomapper)
library(dplyr)
library(ComplexHeatmap)
library(CATALYST)
library(singleCellTK)
library(tidyverse)
library(circlize)
```

# Read in data and get it analysis ready

```{r}
sce_adult = imcRtools::read_steinbock(path="/Volumes/Archive/MouseIMC",
                             intensities_folder = "intensities",
                             regionprops_folder = "regionprops",
                             graphs_folder = "neighbors",
                             pattern = NULL,
                             extract_cellid_from = "Object",
                             extract_coords_from = c("centroid-1", "centroid-0"),
                             image_file = "images.csv",
                             extract_imagemetadata_from = c("width_px", "height_px"),
                             panel_file = "panel.csv",
                             extract_names_from = "name",
                             return_as = "sce")
assay(sce_adult, "exprs") = asinh(counts(sce_adult)/5)

colData(sce_adult)

# Add unique column name identifiers
colnames(sce_adult) = str_c(colData(sce_adult)$sample_id, '_Cell_',colData(sce_adult)$ObjectNumber)

dim(sce_adult) 
unique(sce_adult$sample_id) 
```

# Data Standardization by Marker

Standardize data so that each marker has a mean of 0 and a SD of 1.

```{r}
assay(sce_adult,'exprs') = t(scale(t(assay(sce_adult,'exprs'))))
```

# Clustering into Meta-Clusters

```{r}
markers_to_include = c('CD31','CD29','aSMA','F480','CD68','CD11b','Ly6G','CD4','B220','CD11c','CD161','CD8','CD206', 'CD3','MHCII', 'Ecad','K14','PD1','PDL1','PDPN','PanK','S100A9', 'S100A4', 'Foxp3','GranzymeB', 'Ki67', 'CD45', 'Vimentin','Arg1','CD86')

scaled_sce_adult = as.data.frame((t(assay(sce_adult[rownames(sce_adult) %in% markers_to_include,],'exprs'))))
head(scaled_sce_adult)

scaled_sce_adult = scaled_sce_adult[,c('CD31','CD29','aSMA','F480','CD68','CD11b','Ly6G','CD4','B220','CD11c',
                                       'CD161','CD8','CD206', 'CD3','MHCII', 'Ecad', # Lineage
                                       'K14','PD1','PDL1','PDPN','PanK','S100A9', 'S100A4', 'Foxp3','GranzymeB', 
                                       'Ki67', 'CD45', 'Vimentin','Arg1','CD86')] 

head(scaled_sce_adult)

scaled_sce_adult %>% summary()


# Identify lineage marker as well as top 5 highest expressing markers for each cell
maxn = function(n) function(x) base::order(x, decreasing = TRUE)[!is.na(x)][n]
scaled_sce_adult = scaled_sce_adult %>%
  mutate(Lineage=apply(.[1:16], 1, function(x) names(x)[maxn(1)(x)]))
scaled_sce_adult = scaled_sce_adult %>%
  mutate(Highest=apply(.[1:30], 1, function(x) names(x)[maxn(1)(x)])) # Replace X with total number of markers
scaled_sce_adult = scaled_sce_adult %>%
  mutate(Second_Highest=apply(.[1:30], 1, function(x) names(x)[maxn(2)(x)])) # Replace X with total number of markers
scaled_sce_adult = scaled_sce_adult %>%
  mutate(Third_Highest=apply(.[1:30], 1, function(x) names(x)[maxn(3)(x)])) # Replace X with total number of markers
scaled_sce_adult = scaled_sce_adult %>%
  mutate(Fourth_Highest=apply(.[1:30], 1, function(x) names(x)[maxn(4)(x)])) # Replace X with total number of marker
scaled_sce_adult = scaled_sce_adult %>%
  mutate(Fifth_Highest=apply(.[1:30], 1, function(x) names(x)[maxn(5)(x)])) # Replace X with total number of marker
head(scaled_sce_adult)

# Assign cells to one of 11 meta-clusters (supervised clustering)
scaled_sce_adult = scaled_sce_adult %>% mutate(Label = case_when(
  
  ((Lineage=='CD31')&(CD31>-1)) ~ 'Endothelial cells',
  
  ((Lineage=='CD29')&(CD29>1)) ~ 'Epithelial cells',
  ((Lineage=='Ecad')&(CD29>1)|(Ecad>1)) ~ 'Epithelial cells',

  
  ((Lineage=='aSMA')&(aSMA>0)) ~ 'Myofibroblasts',
  
  #####
  ((Lineage=='B220')&(B220>0)) ~ 'B cells',

  ((Lineage=='CD29')&(B220>0)&(Second_Highest=='B220')) ~ 'B cells',

  ((Lineage=='CD68')&(B220>0)&(Second_Highest=='B220')) ~ 'B cells',

  ((Lineage=='F480')&(B220>0)&(Second_Highest=='B220')) ~ 'B cells',
  
  ##
  
((Lineage=='CD8')&(CD8>-1)&(CD3>0)&
   ((!Highest %in% c('CD68','CD206','F480','CD11c'))&
      (!Second_Highest %in% c('CD68','CD206','F480','CD11c'))&
      (!Third_Highest %in% c('CD68','CD206','F480','CD11c')))) ~ 'CD8+ T-cells',

((Lineage=='CD29')&(CD8>-1)&(Second_Highest=='CD8')) ~ 'CD8+ T-cells',

((Lineage=='CD8')&(CD8>0)&(CD3>0) &
    ((!Highest %in% c('B220','CD68','CD206','F480','aSMA','CD31','CD29','CD11c','CD4'))&
      (!Second_Highest %in% c('B220','CD68','CD206','F480','aSMA','CD31','CD29','CD11c','CD4'))&
      (!Third_Highest %in% c('B220','CD68','CD206','F480','aSMA','CD31','CD29','CD11c','CD4')))) ~ 'CD8+ T-cells',

((Lineage=='CD3')&(CD3>0)&(CD8>0) &
    ((!Highest %in% c('B220','CD68','CD206','F480','aSMA','CD31','CD29','CD11c','CD4'))&
      (!Second_Highest %in% c('B220','CD68','CD206','F480','aSMA','CD31','CD29','CD11c','CD4'))&
      (!Third_Highest %in% c('B220','CD68','CD206','F480','aSMA','CD31','CD29','CD11c','CD4')))) ~ 'CD8+ T-cells',
##
  
  ((Lineage=='F480')&(F480>0)&
     ((!Highest %in% c('CD4','CD8','CD3','B220','aSMA','CD29','CD31'))&
        (!Second_Highest %in% c('CD4','CD8','CD3','B220','aSMA','CD29','CD31'))&
        (!Third_Highest %in% c('CD4','CD8','CD3','B220','aSMA','CD29','CD31'))&
        (!Fourth_Highest %in% c('CD4','CD8','CD3','B220','aSMA','CD29','CD31'))&
        (!Fifth_Highest %in% c( 'CD4','CD8','CD3','B220','aSMA','CD29','CD31')))) ~ 'Macrophages',
  
  ((Lineage=='CD68')&(CD68>0)&
     ((!Highest %in% c('CD4','CD8','CD3','B220','aSMA','CD29','CD31'))&
        (!Second_Highest %in% c('CD4','CD8','CD3','B220','aSMA','CD29','CD31'))&
        (!Third_Highest %in% c('CD4','CD8','CD3','B220','aSMA','CD29','CD31'))&
        (!Fourth_Highest %in% c('CD4','CD8','CD3','B220','aSMA','CD29','CD31'))&
        (!Fifth_Highest %in% c( 'CD4','CD8','CD3','B220','aSMA','CD29','CD31')))) ~ 'Macrophages',
  
  
  ((Lineage=='CD206')&(CD206>0)&
     ((!Highest %in% c('CD4','CD8','CD3','B220','aSMA','CD29','CD31'))&
        (!Second_Highest %in% c('CD4','CD8','CD3','B220','aSMA','CD29','CD31'))&
        (!Third_Highest %in% c('CD4','CD8','CD3','B220','aSMA','CD29','CD31'))&
        (!Fourth_Highest %in% c('CD4','CD8','CD3','B220','aSMA','CD29','CD31'))&
        (!Fifth_Highest %in% c( 'CD4','CD8','CD3','B220','aSMA','CD29','CD31')))) ~ 'Macrophages',
  
 ((Lineage== 'CD29')&(CD68>1)|(CD206>1)|(F480>1) &
    ((!Highest %in% c('CD4','CD8','CD3','B220','aSMA','CD31'))&
        (!Second_Highest %in% c('CD4','CD8','CD3','B220','aSMA','CD31'))&
        (!Third_Highest %in% c('CD4','CD8','CD3','B220','aSMA','CD31'))&
        (!Fourth_Highest %in% c('CD4','CD8','CD3','B220','aSMA','CD31'))&
        (!Fifth_Highest %in% c( 'CD4','CD8','CD3','B220','aSMA','CD31')))) ~ 'Macrophages',
  
  
  ####
  
  ((Lineage=='CD11b')&(CD11b>0)&(Ly6G>0)&
     ((!Highest %in% c('CD29'))&
        (!Second_Highest %in% c('CD29'))&
       (!Third_Highest %in% c('CD29')))) ~'PMN',
  
  ((Lineage=='Ly6G')&(CD11b>0)&(Ly6G>0)&
     ((!Highest %in% c('CD29'))&
        (!Second_Highest %in% c('CD29'))&
        (!Third_Highest %in% c('CD29')))) ~ 'PMN', 
     
    
  ###
  
((Lineage=='CD4')&(CD4>0)&(CD3>0)) ~ 'CD4+ T-cells', 

((Lineage=='CD3')&(CD3>0)&(CD4>0) &
    ((!Highest %in% c('B220','CD68','CD206','F480','aSMA','CD31','CD29','CD11c','CD8'))&
      (!Second_Highest %in% c('B220','CD68','CD206','F480','aSMA','CD31','CD29','CD11c','CD8'))&
      (!Third_Highest %in% c('B220','CD68','CD206','F480','aSMA','CD31','CD29','CD11c','CD8')))) ~ 'CD4+ T-cells',

  ((Lineage %in% c('CD4','CD29','CD68','CD11c'))&(CD4>0)&(CD3>1)&
     ((!Highest %in% c('CD8','B220','CD206','F480','CD31','aSMA'))&
        (!Second_Highest %in% c('CD8','B220','CD206','F480','CD31', 'aSMA'))&
        (!Third_Highest %in% c('CD8','B220','CD206','F480','CD31', 'aSMA')))) ~ 'CD4+ T-cells',
    

  ###
  
  ((Lineage=='CD11c')&(CD11c>0)&(CD11b>-1)&(MHCII>-1)&
  ((!Highest %in% c('CD68'))&
        (!Second_Highest %in% c('CD68'))&
        (!Third_Highest %in% c('CD68')))) ~ 'Dendritic cells',

  ((Lineage=='CD11c')&(CD11c>0)&
  ((!Highest %in% c('CD68'))&
        (!Second_Highest %in% c('CD68'))&
        (!Third_Highest %in% c('CD68')))) ~ 'Dendritic cells',

   ((Lineage=='CD11b')&(CD11c>0)&(CD11b>-1)&(MHCII>-1)&
   ((!Highest %in% c('CD68'))&
        (!Second_Highest %in% c('CD68'))&
        (!Third_Highest %in% c('CD68')))) ~ 'Dendritic cells',
  
 ((Lineage=='MHCII')&(CD11c>0)&(CD11b>-1)&(MHCII>-1)&
    ((!Highest %in% c('CD68'))&
        (!Second_Highest %in% c( 'CD68'))&
        (!Third_Highest %in% c( 'CD68')))) ~ 'Dendritic cells',
  ###
  
((Lineage=='CD161')&(CD161>0)&(CD4>1)&
   ((!Highest %in% c('B220','CD31','aSMA','CD29','CD68','F480','CD206','Ly6G','CD11c'))&
        (!Second_Highest %in% c('B220','CD31','aSMA','CD29','CD68','F480','CD206','Ly6G','CD11c'))&
        (!Third_Highest %in% c('B220','CD31','aSMA','CD29','CD68','F480','CD206','Ly6G','CD11c')))) ~ 'CD4+ T-cells',

((Lineage=='CD161')&(CD161>0)&(CD8>0)&
   ((!Highest %in% c('B220','CD31','aSMA','CD29','CD68','F480','CD206','Ly6G','CD11c'))&
        (!Second_Highest %in% c('B220','CD31','aSMA','CD29','CD68','F480','CD206','Ly6G','CD11c'))&
        (!Third_Highest %in% c('B220','CD31','aSMA','CD29','CD68','F480','CD206','Ly6G','CD11c')))) ~ 'CD8+ T-cells',
  ###
  
  T ~ 'Other non-immune'
))

# Include labels into SCE object
sce_adult$Clusters = scaled_sce_adult$Label

unique(sce_adult$Clusters)

# Create SCE labelled object and set cluster factors and levels
sce_adult_labelled = sce_adult[,sce_adult$Clusters!='Undefined']

sce_adult_labelled$Clusters = factor(sce_adult_labelled$Clusters,
                                     levels=c('Other non-immune', 'Macrophages', 'PMN', 'B cells', 'Endothelial cells', 
                                              'CD4+ T-cells', 'CD8+ T-cells', 'Myofibroblasts', 'Epithelial cells',
                                              'NK/T cells', 'Dendritic cells','Other'))

unique(sce_adult_labelled$Clusters)

```

# SUB-CLUSTERING

CD4+ T Cell Population

```{r}
cd4_cluster = sce_adult_labelled[, sce_adult_labelled$Clusters == 'CD4+ T-cells']

markers = c('CD45','CD4','PD1','Foxp3','Ki67','CD3','MHCII','GranzymeB','PDL1','CD161')

set.seed(88)
cd4_cluster = CATALYST::cluster(cd4_cluster, features = markers, 
                                xdim = 3, ydim = 3, maxK = 5, seed = 88)

# Heatmap
marker_expression <- data.frame(t(assay(cd4_cluster[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(cd4_cluster)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix(t(dat_aggr[,-c(1)]))
colnames(m) <- dat_aggr$cluster_id

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = "'"),
                                              which = "column",
                                              rot = 90,
                                              just = "center",
                                              height = unit(2.3,"cm"),
                                              location = 0.5,
                                              gp = gpar(fontsize=16,col = "black", border = "black")))

cd4_subclusters_flowsom = Heatmap(m, name = "Expression",
                                  cluster_columns = TRUE,
                                  show_column_dend = TRUE,
                                  cluster_rows = FALSE,
                                  show_row_dend = FALSE,
                                  column_names_rot = 45,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  top_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(15,"cm"))

draw(cd4_subclusters_flowsom, heatmap_legend_side = "bottom")

# Annotate and combine clusters

cd4_cluster$Label = NA
cd4_cluster[,cd4_cluster$cluster_id == 5]$Label = "NKT cells"
cd4_cluster[,cd4_cluster$cluster_id %in% c(3,6)]$Label = "CD4+ Tregs"
cd4_cluster[,cd4_cluster$cluster_id %in% c(1,7,4)]$Label = "PD1+ CD4+ T-cells"
cd4_cluster[,cd4_cluster$cluster_id %in% c(2,9,8)]$Label = "CD3+ CD4+ T-cells"

unique(cd4_cluster$Label)
```

CD8+ T Cell Population

```{r}
cd8_cluster = sce_adult_labelled[, sce_adult_labelled$Clusters == 'CD8+ T-cells']

markers = c('CD45','CD8','PD1','Foxp3','Ki67','CD3','MHCII','GranzymeB','PDL1','CD161','CD68')

set.seed(88)
cd8_cluster = CATALYST::cluster(cd8_cluster, features = markers, 
                                xdim = 3, ydim = 3, maxK = 5, seed = 88)

# Heatmap
marker_expression <- data.frame(t(assay(cd8_cluster[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(cd8_cluster)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix(t(dat_aggr[,-c(1)]))
colnames(m) <- dat_aggr$cluster_id

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = "'"),
                                              which = "column",
                                              rot = 90,
                                              just = "center",
                                              height = unit(2.3,"cm"),
                                              location = 0.5,
                                              gp = gpar(fontsize=16,col = "black", border = "black")))

cd8_subclusters_flowsom = Heatmap(m, name = "Expression",
                                  cluster_columns = TRUE,
                                  show_column_dend = TRUE,
                                  cluster_rows = FALSE,
                                  show_row_dend = FALSE,
                                  column_names_rot = 45,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  top_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(15,"cm"))

draw(cd8_subclusters_flowsom, heatmap_legend_side = "bottom")

# Annotate and combine clusters

cd8_cluster$Label = NA
cd8_cluster[,cd8_cluster$cluster_id == 4]$Label = "CD4+ Tregs"
cd8_cluster[,cd8_cluster$cluster_id %in% c(1,7)]$Label = "CD8+ T-cells"
cd8_cluster[,cd8_cluster$cluster_id %in% c(2,3)]$Label = "PD1+ CD8+ T-cells"
cd8_cluster[,cd8_cluster$cluster_id %in% c(9,6,8)]$Label = "Cytotoxic T-cells"
cd8_cluster[,cd8_cluster$cluster_id == 5]$Label = "Proliferating CD8+ T-cells"

unique(cd8_cluster$Label)
```

B Cell Population

```{r}
bcell_cluster = sce_adult_labelled[, sce_adult_labelled$Clusters == 'B cells']

markers = c('CD45','B220','PD1','Foxp3','Ki67','MHCII','PDL1')

set.seed(88)
bcell_cluster = CATALYST::cluster(bcell_cluster, features = markers, 
                                xdim = 3, ydim = 3, maxK = 5, seed = 88)

# Heatmap
marker_expression <- data.frame(t(assay(bcell_cluster[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(bcell_cluster)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix(t(dat_aggr[,-c(1)]))
colnames(m) <- dat_aggr$cluster_id

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = "'"),
                                              which = "column",
                                              rot = 90,
                                              just = "center",
                                              height = unit(2.3,"cm"),
                                              location = 0.5,
                                              gp = gpar(fontsize=16,col = "black", border = "black")))

bcell_subclusters_flowsom = Heatmap(m, name = "Expression",
                                  cluster_columns = TRUE,
                                  show_column_dend = TRUE,
                                  cluster_rows = FALSE,
                                  show_row_dend = FALSE,
                                  column_names_rot = 45,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  top_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(15,"cm"))

draw(bcell_subclusters_flowsom, heatmap_legend_side = "bottom")

# Annotate and combine clusters

bcell_cluster$Label = NA
bcell_cluster[,bcell_cluster$cluster_id == 6]$Label = "CD4+ Tregs"
bcell_cluster[,bcell_cluster$cluster_id %in% c(4,5,7)]$Label = "PDL1+ B cells"
bcell_cluster[,bcell_cluster$cluster_id %in% c(8,9)]$Label = "Proliferating B cells"
bcell_cluster[,bcell_cluster$cluster_id %in% c(1,2,3)]$Label = "B cells"

unique(bcell_cluster$Label)
```

Macrophage Population

```{r}
macrophages_cluster = sce_adult_labelled[, sce_adult_labelled$Clusters == 'Macrophages']

markers = c('CD11b','CD45',
            'Foxp3','CD206','CD68',
            'Ki67','MHCII', 'F480','S100A9', 'S100A4', 'CD86', 'GranzymeB', 'PDL1', 'Arg1')

# First separate into M1 and M2
scaled_macrophages_cluster = as.data.frame(scale(t(assay(macrophages_cluster[rownames(macrophages_cluster) %in% 
                                                                     markers,],'exprs'))))
head(scaled_macrophages_cluster)

scaled_macrophages_cluster = scaled_macrophages_cluster %>% mutate(Label = case_when(
  (CD206>0) ~ 'M2 Macrophages', # &(CD163>HLADR)
  T ~ 'M1 Macrophages'
))

head(scaled_macrophages_cluster)

macrophages_cluster$cluster_id = scaled_macrophages_cluster$Label

# M1 SUBCLUSTERING 
m1_clusters = macrophages_cluster[,macrophages_cluster$cluster_id %in% c('M1 Macrophages')]

markers = c('CD11b','CD45','CD68',
            'Ki67','MHCII', 'F480','S100A9', 'S100A4', 'CD86', 'GranzymeB', 'PDL1', 'Arg1')

set.seed(88)
m1_clusters = CATALYST::cluster(m1_clusters, features = markers, 
                                xdim = 3, ydim = 3, maxK = 5, seed = 88)

# Heatmap
marker_expression <- data.frame(t(assay(m1_clusters[markers_to_include,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(m1_clusters)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix(t(dat_aggr[,-c(1)]))
colnames(m) <- dat_aggr$cluster_id

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = "'"),
                                              which = "column",
                                              rot = 90,
                                              just = "center",
                                              height = unit(2.3,"cm"),
                                              location = 0.5,
                                              gp = gpar(fontsize=16,col = "black", border = "black")))

m1_subclusters_flowsom = Heatmap(m, name = "Expression",
                                  cluster_columns = TRUE,
                                  show_column_dend = TRUE,
                                  cluster_rows = FALSE,
                                  show_row_dend = FALSE,
                                  column_names_rot = 45,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  top_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(15,"cm"))

draw(m1_subclusters_flowsom, heatmap_legend_side = "bottom")


# M2 SUBCLUSTERING 
m2_clusters = macrophages_cluster[,macrophages_cluster$cluster_id %in% c('M2 Macrophages')]

markers = c('CD11b','CD45','CD68','CD206',
            'Ki67','MHCII', 'F480','S100A9', 'S100A4', 'CD86', 'GranzymeB', 'PDL1', 'Arg1')

set.seed(88)
m2_clusters = CATALYST::cluster(m2_clusters, features = markers, 
                                xdim = 3, ydim = 3, maxK = 5, seed = 88)

# Heatmap
marker_expression <- data.frame(t(assay(m2_clusters[markers_to_include,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(m2_clusters)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix(t(dat_aggr[,-c(1)]))
colnames(m) <- dat_aggr$cluster_id

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = "'"),
                                              which = "column",
                                              rot = 90,
                                              just = "center",
                                              height = unit(2.3,"cm"),
                                              location = 0.5,
                                              gp = gpar(fontsize=16,col = "black", border = "black")))

m2_subclusters_flowsom = Heatmap(m, name = "Expression",
                                  cluster_columns = TRUE,
                                  show_column_dend = TRUE,
                                  cluster_rows = FALSE,
                                  show_row_dend = FALSE,
                                  column_names_rot = 45,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  top_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(15,"cm"))

draw(m2_subclusters_flowsom, heatmap_legend_side = "bottom")


# Annotate clusters and combine 
m1_clusters$Label = NA

m1_clusters[,m1_clusters$cluster_id == 4]$Label = "CD86+ M1 macrophages"
m1_clusters[,m1_clusters$cluster_id %in% c(1,2,6,8)]$Label = "M1 macrophages"
m1_clusters[,m1_clusters$cluster_id == 9]$Label = "S100A9+ M1 macrophages"
m1_clusters[,m1_clusters$cluster_id == 3]$Label = "S100A4+ M1 macrophages"
m1_clusters[,m1_clusters$cluster_id %in% c(5,7)]$Label = "Proliferating PDL1+ M1 macrophages"

unique(m1_clusters$Label)


m2_clusters$Label = NA

m2_clusters[,m2_clusters$cluster_id == 3]$Label = "S100A9+ M2 macrophages"
m2_clusters[,m2_clusters$cluster_id %in% c(5,2,9,6)]$Label = "M2 macrophages"
m2_clusters[,m2_clusters$cluster_id == 8]$Label = "CD86+ M2 macrophages"
m2_clusters[,m2_clusters$cluster_id %in% c(4,7)]$Label = "Proliferating PDL1+ M2 macrophages"
m2_clusters[,m2_clusters$cluster_id == 1]$Label = "S100A4+ M2 macrophages"

unique(m2_clusters$Label)

# COMBINE M1 AND M2
unique(m1_clusters$Label)

macrophages_cluster$Label = NA
macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m1_clusters[,m1_clusters$Label %in% c('M1 macrophages')])]$Label = 'M1 macrophages'
macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m1_clusters[,m1_clusters$Label %in% c('S100A9+ M1 macrophages')])]$Label = 'S100A9+ M1 macrophages'
macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m1_clusters[,m1_clusters$Label %in% c('Proliferating PDL1+ M1 macrophages')])]$Label = 'Proliferating PDL1+ M1 macrophages'
macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m1_clusters[,m1_clusters$Label %in% c('CD86+ M1 macrophages')])]$Label = 'CD86+ M1 macrophages'
macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m1_clusters[,m1_clusters$Label %in% c('S100A4+ M1 macrophages')])]$Label = 'S100A4+ M1 macrophages'

unique(m2_clusters$Label)

macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m2_clusters[,m2_clusters$Label %in% c('M2 macrophages')])]$Label = 'M2 macrophages'
macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m2_clusters[,m2_clusters$Label %in% c('CD86+ M2 macrophages')])]$Label = 'CD86+ M2 macrophages'
macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m2_clusters[,m2_clusters$Label %in% c('Proliferating PDL1+ M2 macrophages')])]$Label = 'Proliferating PDL1+ M2 macrophages'
macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m2_clusters[,m2_clusters$Label %in% c('S100A9+ M2 macrophages')])]$Label = 'S100A9+ M2 macrophages'
macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m2_clusters[,m2_clusters$Label %in% c('S100A4+ M2 macrophages')])]$Label = 'S100A4+ M2 macrophages'

unique(macrophages_cluster$Label)
```

Dendritic cell Population

```{r}
Dendritic_cluster = sce_adult_labelled[, sce_adult_labelled$Clusters == 'Dendritic cells']

markers = c('CD11b','Ly6G','CD45','Arg1','Ki67','CD86','PDL1','MHCII','CD11c','Foxp3')

set.seed(88)
Dendritic_cluster = CATALYST::cluster(Dendritic_cluster, features = markers, 
                                        xdim = 3, ydim = 3, maxK = 5, seed = 88)

# Heatmap
marker_expression <- data.frame(t(assay(Dendritic_cluster[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(Dendritic_cluster)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix(t(dat_aggr[,-c(1)]))
colnames(m) <- dat_aggr$cluster_id

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = "'"),
                                              which = "column",
                                              rot = 90,
                                              just = "center",
                                              height = unit(2.3,"cm"),
                                              location = 0.5,
                                              gp = gpar(fontsize=16,col = "black", border = "black")))

Dendritic_subclusters_flowsom = Heatmap(m, name = "Expression",
                                          cluster_columns = TRUE,
                                          show_column_dend = TRUE,
                                          cluster_rows = FALSE,
                                          show_row_dend = FALSE,
                                          column_names_rot = 45,
                                          column_names_centered = FALSE,
                                          show_column_names = TRUE,
                                          row_title_gp = gpar(fontsize = 23),
                                          top_annotation = ha,
                                          col = colorRamp2(c(0, 2), c("white", "red")),
                                          column_names_side = "bottom",
                                          height = unit(8, "cm"),
                                          width = unit(15,"cm"))

draw(Dendritic_subclusters_flowsom, heatmap_legend_side = "bottom")


# Annotate clusters and combine

Dendritic_cluster$Label = NA
Dendritic_cluster[,Dendritic_cluster$cluster_id %in% c(6,5,2,3)]$Label = "Dendritic cells"
Dendritic_cluster[,Dendritic_cluster$cluster_id ==1]$Label = "Proliferating Dendritic cells"
Dendritic_cluster[,Dendritic_cluster$cluster_id %in% c(7,8,9,4)]$Label = "PDL1+ Dendritic cells"

unique(Dendritic_cluster$Label)
```

Other non-immune

```{r}
Otherepithelial_cluster = sce_adult_labelled[, sce_adult_labelled$Clusters == 'Other non-immune']

markers = c('K14','CD29','PDPN','Vimentin','PanK','Arg1')

set.seed(88)
Otherepithelial_cluster = CATALYST::cluster(Otherepithelial_cluster, features = markers, 
                                        xdim = 3, ydim = 3, maxK = 3, seed = 88)

# Heatmap
marker_expression <- data.frame(t(assay(Otherepithelial_cluster[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(Otherepithelial_cluster)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix(t(dat_aggr[,-c(1)]))
colnames(m) <- dat_aggr$cluster_id

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = "'"),
                                              which = "column",
                                              rot = 90,
                                              just = "center",
                                              height = unit(2.3,"cm"),
                                              location = 0.5,
                                              gp = gpar(fontsize=16,col = "black", border = "black")))

Otherepithelial_subclusters_flowsom = Heatmap(m, name = "Expression",
                                          cluster_columns = TRUE,
                                          show_column_dend = TRUE,
                                          cluster_rows = FALSE,
                                          show_row_dend = FALSE,
                                          column_names_rot = 45,
                                          column_names_centered = FALSE,
                                          show_column_names = TRUE,
                                          row_title_gp = gpar(fontsize = 23),
                                          top_annotation = ha,
                                          col = colorRamp2(c(0, 2), c("white", "red")),
                                          column_names_side = "bottom",
                                          height = unit(8, "cm"),
                                          width = unit(15,"cm"))

draw(Otherepithelial_subclusters_flowsom, heatmap_legend_side = "bottom")

# Annotate clusters and combine

Otherepithelial_cluster$Label = NA
Otherepithelial_cluster[,Otherepithelial_cluster$cluster_id %in% c(1,2,3,4,7)]$Label = "Epithelial cells"
Otherepithelial_cluster[,Otherepithelial_cluster$cluster_id %in% c(9,8,6,5)]$Label = "Mesenchymal cells"

unique(Otherepithelial_cluster$Label)
```

Endothelial cells

```{r}
endothelial_cluster = sce_adult_labelled[, sce_adult_labelled$Clusters == 'Endothelial cells']

markers = c('CD31','PDPN', 'Vimentin')

set.seed(88)
endothelial_cluster = CATALYST::cluster(endothelial_cluster, features = markers, 
                                        xdim = 3, ydim = 3, maxK = 3, seed = 88)

# Heatmap
marker_expression <- data.frame(t(assay(endothelial_cluster[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(endothelial_cluster)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix(t(dat_aggr[,-c(1)]))
colnames(m) <- dat_aggr$cluster_id

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = "'"),
                                              which = "column",
                                              rot = 90,
                                              just = "center",
                                              height = unit(2.3,"cm"),
                                              location = 0.5,
                                              gp = gpar(fontsize=16,col = "black", border = "black")))

endothelial_subclusters_flowsom = Heatmap(m, name = "Expression",
                                          cluster_columns = TRUE,
                                          show_column_dend = TRUE,
                                          cluster_rows = FALSE,
                                          show_row_dend = FALSE,
                                          column_names_rot = 45,
                                          column_names_centered = FALSE,
                                          show_column_names = TRUE,
                                          row_title_gp = gpar(fontsize = 23),
                                          top_annotation = ha,
                                          col = colorRamp2(c(0, 2), c("white", "red")),
                                          column_names_side = "bottom",
                                          height = unit(8, "cm"),
                                          width = unit(15,"cm"))

draw(endothelial_subclusters_flowsom, heatmap_legend_side = "bottom")

# Annotate clusters and combine

endothelial_cluster$Label = NA
endothelial_cluster[,endothelial_cluster$cluster_id %in% c(3,6,2,9)]$Label = "Lymphatic Endothelial cells"
endothelial_cluster[,endothelial_cluster$cluster_id %in% c(1,5,8,4,7)]$Label = "Endothelial cells"

unique(endothelial_cluster$Label)
```

# Incorporate subclusters into main SCE object

```{r}
sce_adult_labelled$Subcluster = NA

# CD4 Subclusters
unique(cd4_cluster$Label)
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd4_cluster[,cd4_cluster$Label=='CD3+ CD4+ T-cells'])]$Subcluster = 'CD3+ CD4+ T-cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd4_cluster[,cd4_cluster$Label=='CD4+ Tregs'])]$Subcluster = 'CD4+ Tregs'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd4_cluster[,cd4_cluster$Label=='PD1+ CD4+ T-cells'])]$Subcluster = 'PD1+ CD4+ T-cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd4_cluster[,cd4_cluster$Label=='NKT cells'])]$Subcluster = 'CD4+ NKT-cells'


# CD8 Subclusters
unique(cd8_cluster$Label)
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd8_cluster[,cd8_cluster$Label=='CD8+ T-cells'])]$Subcluster = 'CD3+ CD8+ T-cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd8_cluster[,cd8_cluster$Label=='CD4+ Tregs'])]$Subcluster = 'CD4+ Tregs'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd8_cluster[,cd8_cluster$Label=='Proliferating CD8+ T-cells'])]$Subcluster = 'Proliferating CD8+ T-cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd8_cluster[,cd8_cluster$Label=='Cytotoxic T-cells'])]$Subcluster = 'Cytotoxic T-cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd8_cluster[,cd8_cluster$Label=='PD1+ CD8+ T-cells'])]$Subcluster = 'PD1+ CD8+ T-cells'


# B Cells Subclusters
unique(bcell_cluster$Label)
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(bcell_cluster[,bcell_cluster$Label=='B cells'])]$Subcluster = 'B cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(bcell_cluster[,bcell_cluster$Label=='CD4+ Tregs'])]$Subcluster = 'CD4+ Tregs'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(bcell_cluster[,bcell_cluster$Label=='Proliferating B cells'])]$Subcluster = 'Proliferating B cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(bcell_cluster[,bcell_cluster$Label=='PDL1+ B cells'])]$Subcluster = 'PDL1+ B cells'


# Macrophage Subclusters
unique(macrophages_cluster$Label)
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='M1 macrophages'])]$Subcluster = 'M1 macrophages'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='M2 macrophages'])]$Subcluster = 'M2 macrophages'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='CD86+ M1 macrophages'])]$Subcluster = 'CD86+ M1 macrophages'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='Proliferating PDL1+ M1 macrophages'])]$Subcluster = 'Proliferating PDL1+ M1 macrophages'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='Proliferating PDL1+ M2 macrophages'])]$Subcluster = 'Proliferating PDL1+ M2 macrophages'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='S100A9+ M1 macrophages'])]$Subcluster = 'S100A9+ M1 macrophages'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='S100A9+ M2 macrophages'])]$Subcluster = 'S100A9+ M2 macrophages'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='S100A4+ M1 macrophages'])]$Subcluster = 'S100A4+ M1 macrophages'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='S100A4+ M2 macrophages'])]$Subcluster = 'S100A4+ M2 macrophages'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='CD86+ M2 macrophages'])]$Subcluster = 'CD86+ M2 macrophages'


# Dendritic cell Subclusters
unique(Dendritic_cluster$Label)
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(Dendritic_cluster[,Dendritic_cluster$Label=='Dendritic cells'])]$Subcluster = 'Dendritic cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(Dendritic_cluster[,Dendritic_cluster$Label=='PDL1+ Dendritic cells'])]$Subcluster = 'PDL1+ Dendritic cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(Dendritic_cluster[,Dendritic_cluster$Label=='Proliferating Dendritic cells'])]$Subcluster = 'Proliferating Dendritic cells'

unique(sce_adult_labelled$Subcluster)


# Other non-immune Sub-clusters
unique(Otherepithelial_cluster$Label)
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(Otherepithelial_cluster[,Otherepithelial_cluster$Label=='Epithelial cells'])]$Subcluster = 'Epithelial cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(Otherepithelial_cluster[,Otherepithelial_cluster$Label=='Mesenchymal cells'])]$Subcluster = 'Mesenchymal cells'


# Endothelial cells Subclusters
unique(endothelial_cluster$Label)
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(endothelial_cluster[,endothelial_cluster$Label=='Endothelial cells'])]$Subcluster = 'Endothelial cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(endothelial_cluster[,endothelial_cluster$Label=='Lymphatic Endothelial cells'])]$Subcluster = 'Lymphatic Endothelial cells'


# Add remaining clusters
sce_adult_labelled[,sce_adult_labelled$Clusters == 'PMN']$Subcluster = 'PMN'
sce_adult_labelled[,sce_adult_labelled$Clusters == 'Epithelial cells']$Subcluster = 'Epithelial cells'
sce_adult_labelled[,sce_adult_labelled$Clusters == 'Myofibroblasts']$Subcluster = 'Myofibroblasts'

colData(sce_adult_labelled)
unique(sce_adult_labelled$Subcluster)

# Change Cluster for those CD4+ Tregs that weren't identified as CD4 cells
colData(sce_adult_labelled[,sce_adult_labelled$Subcluster=='CD4+ Tregs'])
sce_adult_labelled[,sce_adult_labelled$Subcluster=='CD4+ Tregs']$Clusters = 'CD4+ T-cells'

# Exclude non-biological cluster (mixed phenotype): Proliferating PDL1+ M2 macrophages
sce_adult_labelled = sce_adult_labelled[,!sce_adult_labelled$Subcluster %in% c('Proliferating PDL1+ M2 macrophages')]
```

# FINAL METACLUSTER HEATMAP

```{r}
markers_to_include = c('aSMA', 'CD29','Ecad', 'CD31', 'CD3', 'CD4', 'CD8', 'B220', 'CD11b', 'CD161', 'Ly6G', 
                       'F480', 'CD68', 'CD206', 'CD11c', 'MHCII')

marker_expression <- data.frame(t(assay(sce_adult_labelled[markers_to_include,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(sce_adult_labelled)[,"Clusters"])
colnames(dat) = "Clusters"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

# Re-ordering column markers
htmap_col_order <- c('Clusters', 'aSMA', 'CD29','Ecad', 'CD31', 'CD3', 'CD4', 'CD8', 'B220', 'CD11b', 
                     'CD161', 'Ly6G', 'F480', 'CD68', 'CD206', 'CD11c', 'MHCII' )
dat <- dat[, htmap_col_order]

dat_aggr <- dat %>%
  group_by(Clusters) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(Clusters) %>%
  dplyr::summarise(n=n())

rownames(dat_sum) = dat_sum$Clusters
dat_sum = dat_sum[c('Other non-immune', 'Myofibroblasts', 'Epithelial cells', 'Endothelial cells', 
                    'CD4+ T-cells', 'CD8+ T-cells', 'B cells', 'PMN', 'Macrophages', 'Dendritic cells'),]

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Clusters

m = m[c('Other non-immune', 'Myofibroblasts', 'Epithelial cells', 'Endothelial cells', 
                    'CD4+ T-cells', 'CD8+ T-cells', 'B cells', 'PMN', 'Macrophages', 'Dendritic cells'),]


ha_right <- rowAnnotation(" " = anno_barplot((as.numeric(dat_sum[2,])),
                                                     add_numbers = TRUE,numbers_gp = gpar(fontsize = 20),
                                                     which = "row",
                                                     numbers_rot=0,
                                                     ylim=c(0,300000),
                                                     axis=FALSE,
                                                     border=FALSE,
                                                     width = unit(3, "cm")))


col_fun = colorRamp2(c(1,2,3,4,5,6,7,8,9,10), 
                     c("lightblue","#C04000","#313695",
                      "#FFEA00", "orange","#0096FF","green",
                       "#ae017e","#bf812d", "#CCCCFF"))
ha_left = HeatmapAnnotation(Metaclusters = 1:10, col = list(Metaclusters = col_fun), annotation_name_rot=45, 
                            annotation_name_gp=gpar(fontsize=25),gp = gpar(col = "black"), 
                            which='row', show_legend = FALSE)

metaclusters_2 = Heatmap(m, name = "Scaled expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = FALSE,
                                  show_row_dend = FALSE,
                                  column_names_rot = 45,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23), #23
                                  row_names_gp = gpar(fontsize = 25),
                                  column_names_gp = gpar(fontsize = 25),
                                  right_annotation = ha_right,
                                  left_annotation = ha_left,
                                  rect_gp = gpar(col = "white", lwd = 2),
                                  col = colorRamp2(c(-1, 0, 2), hcl_palette='viridis'),
                                  heatmap_legend_param = list(at = c(-1:2), legend_width = unit(6,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=12),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  row_names_side = 'left',
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(metaclusters_2, heatmap_legend_side = "top")
```

# Heatmap Visualization of Subclusters

```{r}
###################
# All subclusters #
###################

markers_to_include = c('CD31','CD29','aSMA','Ecad','K14','PDPN','PanK','Vimentin','Arg1','CD45', 'F480','CD68','CD206','CD11b','Ly6G','MHCII','CD86','PDL1','S100A9', 'S100A4','CD11c','CD161','CD3', 'CD4','CD8','Foxp3','B220','PD1', 'GranzymeB','Ki67')

# Non-immune

subclusters_nonimmune = sce_adult_labelled[,sce_adult_labelled$Subcluster%in% 
                                             c('Epithelial cells','Mesenchymal cells','Endothelial cells','Lymphatic Endothelial cells', 'Myofibroblasts')]

marker_expression <- data.frame(t(assay(subclusters_nonimmune[markers_to_include,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(subclusters_nonimmune)[,"Subcluster"])
colnames(dat) = "Subcluster"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

htmap_col_order <- c('Subcluster','CD31','CD29','aSMA','Ecad','K14','PDPN','PanK','Vimentin','Arg1','CD45', 'F480','CD68','CD206','CD11b','Ly6G','MHCII','CD86','PDL1','S100A9', 'S100A4','CD11c','CD161','CD3', 'CD4','CD8','Foxp3','B220','PD1', 'GranzymeB','Ki67')
dat <- dat[, htmap_col_order]

dat_aggr <- dat %>%
  group_by(Subcluster) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(Subcluster) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Subcluster

ha_right <- rowAnnotation(" " = anno_barplot((as.numeric(dat_sum[2,])),
                                                     add_numbers = TRUE,
                                                     which = "row",
                                                     numbers_rot=0,
                                                     ylim=c(0,300000),
                                                     axis=FALSE,
                                                     border=FALSE,
                                                     width = unit(3, "cm")))

col_fun = colorRamp2(c(1,2,3,4,5),
                     c("#C04000","#C04000","#313695","#313695","lightblue"))
 
ha_left = HeatmapAnnotation(Metaclusters = 1:5, col = list(Metaclusters = col_fun),
                            gp = gpar(col = "black"), which='row', show_legend = FALSE)

subclusters = Heatmap(m, name = "Scaled expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = FALSE,
                                  show_row_dend = FALSE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 20),
                                  right_annotation = ha_right,
                                  left_annotation = ha_left,
                                  rect_gp = gpar(col = "white", lwd = 2),
                                  col = colorRamp2(c(-1, 0, 2), hcl_palette='viridis'),
                                  heatmap_legend_param = list(at = c(-1:2), legend_width = unit(6,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  row_names_side = 'left',
                                  height = unit(2.2, "cm"), #18
                                  width = unit(18,"cm")
                      )

draw(subclusters, heatmap_legend_side = "bottom")

tiff("Heatmap_all_subclusters_nonimmune.tiff", units="in", width=13, height=10, res=300)
draw(subclusters, heatmap_legend_side = "bottom")
dev.off()

# Immune

subclusters_immune = sce_adult_labelled[,!sce_adult_labelled$Subcluster %in% 
                                             c('Epithelial cells','Mesenchymal cells','Endothelial cells','Lymphatic Endothelial cells', 'Myofibroblasts')]

marker_expression <- data.frame(t(assay(subclusters_immune[markers_to_include,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(subclusters_immune)[,"Subcluster"])
colnames(dat) = "Subcluster"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(Subcluster) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(Subcluster) %>%
  dplyr::summarise(n=n())

rownames(dat_sum) = dat_sum$Subcluster
dat_sum = dat_sum[c('B cells','Proliferating B cells','PDL1+ B cells',
        'CD3+ CD4+ T-cells','CD4+ Tregs','PD1+ CD4+ T-cells',
            'CD4+ NKT-cells',
            'CD3+ CD8+ T-cells','Cytotoxic T-cells',
            'PD1+ CD8+ T-cells','Proliferating CD8+ T-cells',
            'M1 macrophages','CD86+ M1 macrophages','S100A9+ M1 macrophages','S100A4+ M1 macrophages',
        'Proliferating PDL1+ M1 macrophages',
            'M2 macrophages','S100A4+ M2 macrophages',
            'S100A9+ M2 macrophages','CD86+ M2 macrophages',
            'Dendritic cells','PDL1+ Dendritic cells','Proliferating Dendritic cells','PMN'),]

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Subcluster

m = m[c('B cells','Proliferating B cells','PDL1+ B cells',
        'CD3+ CD4+ T-cells','CD4+ Tregs','PD1+ CD4+ T-cells',
            'CD4+ NKT-cells',
            'CD3+ CD8+ T-cells','Cytotoxic T-cells',
            'PD1+ CD8+ T-cells','Proliferating CD8+ T-cells',
            'M1 macrophages','CD86+ M1 macrophages','S100A9+ M1 macrophages','S100A4+ M1 macrophages',
        'Proliferating PDL1+ M1 macrophages',
            'M2 macrophages','S100A4+ M2 macrophages',
            'S100A9+ M2 macrophages','CD86+ M2 macrophages',
            'Dendritic cells','PDL1+ Dendritic cells','Proliferating Dendritic cells','PMN'),]

dat_sum[,1]

ha_right <- rowAnnotation(" " = anno_barplot((as.numeric(dat_sum[2,])),
                                                     add_numbers = TRUE,
                                                     which = "row",
                                                     numbers_rot=0,
                                                     ylim=c(0,35000),
                                                     axis=FALSE,
                                                     border=FALSE,
                                                     width = unit(3, "cm")))

col_fun = colorRamp2(c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,
                       24),
                     c("green","green","green", "orange","orange","orange","orange",
                       "#0096FF","#0096FF","#0096FF","#0096FF",
                       "#bf812d","#bf812d", "#bf812d","#bf812d","#bf812d", "#bf812d","#bf812d","#bf812d","#bf812d",
                      "#CCCCFF", "#CCCCFF", "#CCCCFF",  "#ae017e"))
                     
ha_left = HeatmapAnnotation(Metaclusters = 1:24, col = list(Metaclusters = col_fun),
                            gp = gpar(col = "black"), which='row', show_legend = FALSE)

subclusters = Heatmap(m, name = "Scaled expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = FALSE,
                                  show_row_dend = FALSE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  right_annotation = ha_right,
                                  left_annotation = ha_left,
                                  rect_gp = gpar(col = "white", lwd = 2),
                                  col = colorRamp2(c(-1, 0, 2), hcl_palette='viridis'),
                                  heatmap_legend_param = list(at = c(-1:2), legend_width = unit(6,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  row_names_side = 'left',
                                  height = unit(18, "cm"), 
                                  width = unit(20,"cm")
                      )

draw(subclusters, heatmap_legend_side = "bottom")

tiff("Heatmap_all_subclusters_immune.tiff", units="in", width=13, height=10, res=300)
draw(subclusters, heatmap_legend_side = "bottom")
dev.off()

sce_adult_labelled = sce_adult_labelled[,!sce_adult_labelled$Subcluster %in% c('Proliferating PDL1+ M2 macrophages')]


###############
# CD4 T cells #
###############

temp_sce = sce_adult_labelled[,sce_adult_labelled$Clusters=='CD4+ T-cells']
markers = c('CD45','CD4','PD1','Foxp3','Ki67','CD3','MHCII','GranzymeB','PDL1','CD161')

# Heatmap
marker_expression <- data.frame(t(assay(temp_sce[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(temp_sce)[,"Subcluster"])
colnames(dat) = "Subcluster"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(Subcluster) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(Subcluster) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Subcluster

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = ","),
                                              which = "row",
                                              rot = 0,
                                              just = "right",
                                              width = unit(2,"cm"),
                                              location = 0.9,
                                              gp = gpar(fontsize=14,col = "black", border = "black")),
                        which = "row")
subclusters_labelled = Heatmap(m, name = "Expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = TRUE,
                                  show_row_dend = TRUE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  left_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(subclusters_labelled, heatmap_legend_side = "bottom")

###############
# CD8 T cells #
###############

temp_sce = sce_adult_labelled[,sce_adult_labelled$Clusters=='CD8+ T-cells']
markers = c('CD45','CD8','PD1','Ki67','CD3','MHCII','GranzymeB','PDL1','CD161')

# Heatmap
marker_expression <- data.frame(t(assay(temp_sce[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(temp_sce)[,"Subcluster"])
colnames(dat) = "Subcluster"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(Subcluster) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(Subcluster) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Subcluster

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = ","),
                                              which = "row",
                                              rot = 0,
                                              just = "right",
                                              width = unit(2,"cm"),
                                              location = 0.9,
                                              gp = gpar(fontsize=14,col = "black", border = "black")),
                        which = "row")
subclusters_labelled = Heatmap(m, name = "Expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = TRUE,
                                  show_row_dend = TRUE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  left_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(subclusters_labelled, heatmap_legend_side = "bottom")

###########
# B cells #
###########

temp_sce = sce_adult_labelled[,sce_adult_labelled$Clusters=='B cells']
markers = c('CD45','B220','PD1','Ki67','MHCII','PDL1')

# Heatmap
marker_expression <- data.frame(t(assay(temp_sce[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(temp_sce)[,"Subcluster"])
colnames(dat) = "Subcluster"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(Subcluster) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(Subcluster) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Subcluster

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = ","),
                                              which = "row",
                                              rot = 0,
                                              just = "right",
                                              width = unit(2,"cm"),
                                              location = 0.9,
                                              gp = gpar(fontsize=14,col = "black", border = "black")),
                        which = "row")
subclusters_labelled = Heatmap(m, name = "Expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = TRUE,
                                  show_row_dend = TRUE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  left_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(subclusters_labelled, heatmap_legend_side = "bottom")

###############
# Macrophages #
###############

temp_sce = sce_adult_labelled[,sce_adult_labelled$Clusters=='Macrophages']
markers = c('CD11b','CD45','CD206','CD68',
            'Ki67','MHCII', 'F480','S100A9','S100A4','CD86','GranzymeB','PDL1','Arg1')

# Heatmap
marker_expression <- data.frame(t(assay(temp_sce[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(temp_sce)[,"Subcluster"])
colnames(dat) = "Subcluster"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(Subcluster) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(Subcluster) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Subcluster

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = ","),
                                              which = "row",
                                              rot = 0,
                                              just = "right",
                                              width = unit(2,"cm"),
                                              location = 0.9,
                                              gp = gpar(fontsize=14,col = "black", border = "black")),
                        which = "row")
subclusters_labelled = Heatmap(m, name = "Expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = TRUE,
                                  show_row_dend = TRUE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  left_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(subclusters_labelled, heatmap_legend_side = "bottom")

###################
# Dendritic cells #
###################

temp_sce = sce_adult_labelled[,sce_adult_labelled$Clusters=='Dendritic cells']
markers = c('CD11b','Ly6G','CD45','Arg1',
            'Ki67','CD86','PDL1','MHCII','CD11c')

# Heatmap
marker_expression <- data.frame(t(assay(temp_sce[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(temp_sce)[,"Subcluster"])
colnames(dat) = "Subcluster"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(Subcluster) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(Subcluster) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Subcluster

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = ","),
                                              which = "row",
                                              rot = 0,
                                              just = "right",
                                              width = unit(2,"cm"),
                                              location = 0.9,
                                              gp = gpar(fontsize=14,col = "black", border = "black")),
                        which = "row")
subclusters_labelled = Heatmap(m, name = "Expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = TRUE,
                                  show_row_dend = TRUE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  left_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(subclusters_labelled, heatmap_legend_side = "bottom")

###################
#Other non-immune #
###################

temp_sce = sce_adult_labelled[,sce_adult_labelled$Clusters=='Other non-immune']
markers = c('K14','CD29','PDPN','Vimentin','PanK','Arg1')

# Heatmap
marker_expression <- data.frame(t(assay(temp_sce[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(temp_sce)[,"Subcluster"])
colnames(dat) = "Subcluster"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(Subcluster) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(Subcluster) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Subcluster

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = ","),
                                              which = "row",
                                              rot = 0,
                                              just = "right",
                                              width = unit(2,"cm"),
                                              location = 0.9,
                                              gp = gpar(fontsize=14,col = "black", border = "black")),
                        which = "row")
subclusters_labelled = Heatmap(m, name = "Expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = TRUE,
                                  show_row_dend = TRUE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  left_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(subclusters_labelled, heatmap_legend_side = "bottom")

#####################
# Endothelial cells #
#####################

temp_sce = sce_adult_labelled[,sce_adult_labelled$Clusters=='Endothelial cells']
markers = c('CD31','PDPN','Vimentin')

# Heatmap
marker_expression <- data.frame(t(assay(temp_sce[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(temp_sce)[,"Subcluster"])
colnames(dat) = "Subcluster"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(Subcluster) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(Subcluster) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Subcluster

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = ","),
                                              which = "row",
                                              rot = 0,
                                              just = "right",
                                              width = unit(2,"cm"),
                                              location = 0.9,
                                              gp = gpar(fontsize=14,col = "black", border = "black")),
                        which = "row")
subclusters_labelled = Heatmap(m, name = "Expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = TRUE,
                                  show_row_dend = TRUE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  left_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(subclusters_labelled, heatmap_legend_side = "bottom")
```

Export object

```{r}
exportSCE(sce_adult_labelled, samplename = "method_mouse_data", directory = "./", type = "Cells", format = "SCE")
```

