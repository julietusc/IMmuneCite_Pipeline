---
title: "Human Clustering"
author: "Sarah Bangerth"
date: "2023-10-31"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

setwd('/users/sarahbangerth/Desktop/IMC/Adult IMC Output')

## Libraries
library(imcRtools)
library(cytomapper)
library(dplyr)
library(ComplexHeatmap)
library(CATALYST)
library(singleCellTK)
library(tidyverse)
library(circlize)
```

# Read in data and get it analysis ready

```{r}
sce_adult = imcRtools::read_steinbock(path="/users/sarahbangerth/Desktop/IMC/Adult IMC Output/Data/Final/Mesmer",
                             intensities_folder = "intensities",
                             regionprops_folder = "regionprops",
                             graphs_folder = "neighbors",
                             pattern = NULL,
                             extract_cellid_from = "Object",
                             extract_coords_from = c("centroid-1", "centroid-0"),
                             image_file = "images.csv",
                             extract_imagemetadata_from = c("width_px", "height_px"),
                             panel_file = "panel.csv",
                             extract_names_from = "name",
                             return_as = "sce")
assay(sce_adult, "exprs") = asinh(counts(sce_adult)/5)

colData(sce_adult)

# Add unique column name identifiers
colnames(sce_adult) = str_c(colData(sce_adult)$sample_id, '_Cell_', colData(sce_adult)$ObjectNumber)

dim(sce_adult)
unique(sce_adult$sample_id)

# # Add patient label
# colData(sce_adult)$Patient = as.vector(str_extract_all(sce_adult$sample_id, "SP_?[0-9]+_[0-9]+A?1?", simplify = TRUE))
# 
# ### Adjust one sample
# sce_adult[,sce_adult$sample_id == 'SP21_414_A1_001']$Patient = 'SP21_414_A1'
# 
# # Add group label
# group_label = read_csv("/users/sarahbangerth/Desktop/IMC/Adult IMC Output/Data/Final/sample_metadata.csv")
# head(group_label)
# 
# sce_adult$group = group_label$group[match(sce_adult$Patient, group_label$Patient)]
# unique(sce_adult[,is.na(sce_adult$group)]$Patient)
# unique(sce_adult$group)
# 
# sce_adult[,sce_adult$group == 'NO REJ']$group = 'NR'
# 
# # Checking to make sure all ROIs were assigned a group label
# unique(sce_adult[,is.na(sce_adult$group)]$sample_id)
# 
# # Set group order for plots
# sce_adult$group = factor(sce_adult$group, levels=c('NR','TCMR','CR'))
# sce_adult$group
# 
# # Number of ROIs
# unique(sce_adult$sample_id)
# 
# unique(sce_adult[,sce_adult$group=='NR']$sample_id)
# unique(sce_adult[,sce_adult$group=='TCMR']$sample_id)
# unique(sce_adult[,sce_adult$group=='CR']$sample_id)
```

# Data Standardization by Marker

Standardize data so that each marker has a mean of 0 and a SD of 1.

```{r}
assay(sce_adult,'exprs') = t(scale(t(assay(sce_adult,'exprs'))))
```

# Clustering into Metaclusters

```{r}
markers_to_include = c('CD66b','CD20','CD28','CD16','CD163','CD11b','CD45',
                       'CD4','CD31','CD279','CD68','Foxp3',
                       'CK7','Ki67','CD8',
                       'CD3','CD138','HLADR','GranzymeB')


scaled_sce_adult = as.data.frame((t(assay(sce_adult[rownames(sce_adult) %in% markers_to_include,],'exprs'))))
head(scaled_sce_adult)

scaled_sce_adult = scaled_sce_adult[,c('CD4','CD8','CD20','CD11b','CD68','CD163','CD66b','CD31','CK7','CD138', #Lineage
                                             'CD28','CD16','CD45',
                                             'CD279','Foxp3','Ki67',
                                             'CD3','HLADR','GranzymeB')]
head(scaled_sce_adult)

scaled_sce_adult %>% summary()

# Identify lineage marker as well as top 3 highest expressing markers for each cell
maxn = function(n) function(x) base::order(x, decreasing = TRUE)[!is.na(x)][n]
scaled_sce_adult = scaled_sce_adult %>%
  mutate(Lineage=apply(.[1:10], 1, function(x) names(x)[maxn(1)(x)]))
scaled_sce_adult = scaled_sce_adult %>%
  mutate(Highest=apply(.[1:19], 1, function(x) names(x)[maxn(1)(x)]))
scaled_sce_adult = scaled_sce_adult %>%
  mutate(Second_Highest=apply(.[1:19], 1, function(x) names(x)[maxn(2)(x)]))
scaled_sce_adult = scaled_sce_adult %>%
  mutate(Third_Highest=apply(.[1:19], 1, function(x) names(x)[maxn(3)(x)]))

head(scaled_sce_adult)

# Assign cells to one of 10 meta-clusters (supervised clustering)
scaled_sce_adult = scaled_sce_adult %>% mutate(Label = case_when(

   ((Lineage=='CD31')&(CD31>0)) ~ 'Endothelial cells',

  ((Lineage=='CK7')&(CK7>0)) ~ 'Cholangiocytes',

  #####

  ((Lineage=='CD163')&(CD163>-1)&
     ((!Highest %in% c('CD4','CD8','CD20','CD66b','CD31','CK7'))&
        (!Second_Highest %in% c('CD4','CD8','CD20','CD66b','CD31','CK7'))&
        (!Third_Highest %in% c('CD4','CD8','CD20','CD66b','CD31','CK7')))) ~ 'Macrophages',

  ((Lineage=='CD68')&(CD68>-1)&
     ((!Highest %in% c('CD4','CD8','CD20','CD66b','CD31','CK7'))&
        (!Second_Highest %in% c('CD4','CD8','CD20','CD66b','CD31','CK7'))&
        (!Third_Highest %in% c('CD4','CD8','CD20','CD66b','CD31','CK7')))) ~ 'Macrophages',

  ((Lineage=='CD11b')&(CD68>-1)&(Second_Highest=='CD68')&(CD16<0)) ~ 'Macrophages',
  ((Lineage=='CD11b')&(CD163>-1)&(Second_Highest=='CD163')&(CD16<0)) ~ 'Macrophages',

  ####

  ((Lineage=='CD11b')&(CD11b>-1)&
     ((!Highest %in% c('CD4','CD8','CD20','CD31','CK7','CD68','CD163'))&
        (!Second_Highest %in% c('CD4','CD8','CD20','CD31','CK7','CD68','CD163'))&
        (!Third_Highest %in% c('CD4','CD8','CD20','CD31','CK7','CD68','CD163')))) ~ 'Monocytes',

  ####

  ((Lineage=='CD8')&(CD8>0)&(CD3>-1)&
     ((!Highest %in% c('CD20','CD68','CD163','CD66b','CD31','CK7'))&
        (!Second_Highest %in% c('CD20','CD68','CD163','CD66b','CD31','CK7'))&
        (!Third_Highest %in% c('CD20','CD68','CD163','CD66b','CD31','CK7')))) ~ 'CD8+ T-cells',
  ((Lineage=='CD11b')&(CD8>0)&(Second_Highest=='CD8')) ~ 'CD8+ T-cells',

  ((Lineage %in% c('CD8','CD68','CD163'))&(CD8>0)&(CD3>0)&
     ((!Highest %in% c('CD20','CD66b','CD31','CK7'))&
        (!Second_Highest %in% c('CD20','CD66b','CD31','CK7'))&
        (!Third_Highest %in% c('CD20','CD66b','CD31','CK7')))) ~ 'CD8+ T-cells',

  ((Lineage %in% c('CD8','CD4'))&(CD8>0)&(CD3>0)&
     ((!Highest %in% c('CD20','CD66b','CD31','CK7'))&
        (!Second_Highest %in% c('CD20','CD66b','CD31','CK7'))&
        (!Third_Highest %in% c('CD20','CD66b','CD31','CK7')))) ~ 'CD8+ T-cells',

  ###

  ((Lineage=='CD4')&(CD4>0)&(CD3>-1)&
     ((!Highest %in% c('CD20','CD68','CD163','CD66b','CD31','CK7','GranzymeB'))&
        (!Second_Highest %in% c('CD20','CD68','CD163','CD66b','CD31','CK7','GranzymeB'))&
        (!Third_Highest %in% c('CD20','CD68','CD163','CD66b','CD31','CK7','GranzymeB')))) ~ 'CD4+ T-cells',
  ((Lineage=='CD11b')&(CD4>0)&(Second_Highest=='CD4')) ~ 'CD4+ T-cells',

  ((Lineage %in% c('CD4','CD68','CD163'))&(CD4>0)&(CD3>0)&
     ((!Highest %in% c('CD20','CD66b','CD31','CK7','GranzymeB'))&
        (!Second_Highest %in% c('CD20','CD66b','CD31','CK7','GranzymeB'))&
        (!Third_Highest %in% c('CD20','CD66b','CD31','CK7','GranzymeB')))) ~ 'CD4+ T-cells',

  ###

  ((Lineage=='CD20')&(CD20>0)&
     ((!Highest %in% c('CD4','CD8','CD68','CD163','CD66b','CD31','CK7','GranzymeB'))&
        (!Second_Highest %in% c('CD4','CD8','CD68','CD163','CD66b','CD31','CK7','GranzymeB'))&
        (!Third_Highest %in% c('CD4','CD8','CD68','CD163','CD31','CK7','GranzymeB')))) ~ 'B cells',

  ((Lineage=='CD66b')&(CD66b>0)&
     ((!Highest %in% c('CD4','CD8','CD20','CK7','CD68','CD31','CD163'))&
        (!Second_Highest %in% c('CD4','CD8','CD20','CK7','CD68','CD31','CD163'))&
        (!Third_Highest %in% c('CD4','CD8','CD20','CK7','CD68','CD31','CD163')))) ~ 'Neutrophils',

  ((CD4<0)&(CD8<0)&(CD20<0)&(CD11b<0)&(CD68<0)&(CD163<0)&(CD66b<0)&(CD31<0)&(CK7<0)&
     (CD28<0)&(CD16<0)&(CD45<0)&(CD279<0)&(Foxp3<0)&(CD3<0)&(HLADR<0)&(GranzymeB<0)) ~ 'Hepatocytes',

  ((Lineage=='CD138')&(CD138>0)&((CD45>0)|(HLADR>0))&
     ((Highest %in% c('CD138','CD45','HLADR'))&
        (Second_Highest %in% c('CD138','CD45','HLADR')))) ~ 'Plasma cells',

  (Lineage=='CD138') ~ 'Hepatocytes',

  T ~ 'Hepatocytes'
))

# Include labels into SCE object
sce_adult$Clusters = scaled_sce_adult$Label

unique(sce_adult$Clusters)

# Create SCE labelled object and set cluster factors and levels
sce_adult_labelled = sce_adult[,sce_adult$Clusters!='Other']

sce_adult_labelled$Clusters = factor(sce_adult_labelled$Clusters,
                                           levels=c('B cells', 'CD4+ T-cells', 'CD8+ T-cells', 'Monocytes',
                                                    'Macrophages', "Neutrophils","Plasma cells",
                                                    "Endothelial cells","Cholangiocytes","Hepatocytes"))
unique(sce_adult_labelled$Clusters)
```

# SUB-CLUSTERING

CD4+ T Cell Population

```{r}
cd4_cluster = sce_adult_labelled[, sce_adult_labelled$Clusters == 'CD4+ T-cells']

############################################
# First separate into CD3 high and CD3 low #
############################################

markers = c('CD28','CD16','CD11b','CD45','CD4','CD279','Foxp3','Ki67','CD3','HLADR')

df_cd4_cluster = as.data.frame((t(assay(cd4_cluster[rownames(cd4_cluster) %in% markers,],'exprs'))))
head(df_cd4_cluster)

df_cd4_cluster = df_cd4_cluster %>% mutate(Label = case_when(
  (CD3>0) ~ 'CD3+',
  T ~ 'CD3-'
))

head(df_cd4_cluster)

cd4_cluster$cluster_id = df_cd4_cluster$Label


############
# CD3-HIGH #
############
cd3high_cluster = cd4_cluster[, cd4_cluster$cluster_id == 'CD3+']

markers = c('CD28','CD16','CD11b','CD45','CD4','CD279','Foxp3','Ki67','CD3','HLADR')

set.seed(88)
cd3high_cluster = CATALYST::cluster(cd3high_cluster, features = markers, 
                                xdim = 3, ydim = 3, maxK = 5, seed = 88)

# Heatmap
marker_expression <- data.frame(t(assay(cd3high_cluster[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(cd3high_cluster)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix(t(dat_aggr[,-c(1)]))
colnames(m) <- dat_aggr$cluster_id

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = "'"),
                                              which = "column",
                                              rot = 90,
                                              just = "center",
                                              height = unit(2.3,"cm"),
                                              location = 0.5,
                                              gp = gpar(fontsize=16,col = "black", border = "black")))

cd3high_subclusters_flowsom = Heatmap(m, name = "Expression",
                                  cluster_columns = TRUE,
                                  show_column_dend = TRUE,
                                  cluster_rows = FALSE,
                                  show_row_dend = FALSE,
                                  column_names_rot = 45,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  top_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(15,"cm"))

draw(cd3high_subclusters_flowsom, heatmap_legend_side = "bottom")

###########
# CD3-LOW #
###########
cd3low_cluster = cd4_cluster[, cd4_cluster$cluster_id == 'CD3-']

markers = c('CD28','CD16','CD11b','CD45','CD4','CD279','Foxp3','Ki67','CD3','HLADR')

set.seed(88)
cd3low_cluster = CATALYST::cluster(cd3low_cluster, features = markers, 
                                xdim = 3, ydim = 3, maxK = 5, seed = 88)


# Heatmap
marker_expression <- data.frame(t(assay(cd3low_cluster[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(cd3low_cluster)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix(t(dat_aggr[,-c(1)]))
colnames(m) <- dat_aggr$cluster_id

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = "'"),
                                              which = "column",
                                              rot = 90,
                                              just = "center",
                                              height = unit(2.3,"cm"),
                                              location = 0.5,
                                              gp = gpar(fontsize=16,col = "black", border = "black")))

cd3low_subclusters_flowsom = Heatmap(m, name = "Expression",
                                  cluster_columns = TRUE,
                                  show_column_dend = TRUE,
                                  cluster_rows = FALSE,
                                  show_row_dend = FALSE,
                                  column_names_rot = 45,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  top_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(15,"cm"))

draw(cd3low_subclusters_flowsom, heatmap_legend_side = "bottom")

#################################
# Annotate clusters and combine #
#################################

cd3high_cluster$Label = NA

cd3high_cluster[,cd3high_cluster$cluster_id == 1]$Label = "HLADR+ CD3-high CD4 T cells"
cd3high_cluster[,cd3high_cluster$cluster_id %in% c(4,7,8,9)]$Label = "CD3-high CD4 T cells"
cd3high_cluster[,cd3high_cluster$cluster_id == 3]$Label = "CD4 Treg cells"
cd3high_cluster[,cd3high_cluster$cluster_id == 2]$Label = "Proliferating CD3-high CD4 T cells"
cd3high_cluster[,cd3high_cluster$cluster_id == 5]$Label = "PD1+ CD3-high CD4 T cells"
cd3high_cluster[,cd3high_cluster$cluster_id == 6]$Label = "CD28+ CD3-high CD4 T cells"

unique(cd3high_cluster$Label)

cd3low_cluster$Label = NA

cd3low_cluster[,cd3low_cluster$cluster_id == 2]$Label = "HLADR+ CD3-low CD4 T cells"
cd3low_cluster[,cd3low_cluster$cluster_id %in% c(1,4,5,8,9)]$Label = "CD3-low CD4 T cells"
cd3low_cluster[,cd3low_cluster$cluster_id == 7]$Label = "PD1+ CD28+ CD3-low CD4 T cells"
cd3low_cluster[,cd3low_cluster$cluster_id %in% c(3,6)]$Label = "CD16+ CD3-low CD4 T cells"

unique(cd3low_cluster$Label)


############################
# COMBINE CD3-HIGH AND LOW #
############################

unique(cd3high_cluster$Label)

cd4_cluster$Label = NA
cd4_cluster[,colnames(cd4_cluster) %in% 
                      colnames(cd3high_cluster[,cd3high_cluster$Label %in% c('CD3-high CD4 T cells')])]$Label = 'CD4+ T-cells'
cd4_cluster[,colnames(cd4_cluster) %in% 
                      colnames(cd3high_cluster[,cd3high_cluster$Label %in% c('CD4 Treg cells')])]$Label = 'CD4+ Tregs'
cd4_cluster[,colnames(cd4_cluster) %in% 
                      colnames(cd3high_cluster[,cd3high_cluster$Label %in% c('Proliferating CD3-high CD4 T cells')])]$Label = 'Ki67+ CD4+ T-cells'
cd4_cluster[,colnames(cd4_cluster) %in% 
                      colnames(cd3high_cluster[,cd3high_cluster$Label %in% c('PD1+ CD3-high CD4 T cells')])]$Label = 'PD1+ CD4+ T-cells'
cd4_cluster[,colnames(cd4_cluster) %in% 
                      colnames(cd3high_cluster[,cd3high_cluster$Label %in% c('CD28+ CD3-high CD4 T cells')])]$Label = 'Naive CD4+ T-cells'
cd4_cluster[,colnames(cd4_cluster) %in% 
                      colnames(cd3high_cluster[,cd3high_cluster$Label %in% c('HLADR+ CD3-high CD4 T cells')])]$Label = 'Activated CD4+ T-cells'


unique(cd3low_cluster$Label)

cd4_cluster[,colnames(cd4_cluster) %in% 
                      colnames(cd3low_cluster[,cd3low_cluster$Label %in% c('CD3-low CD4 T cells')])]$Label = 'Resident memory CD4+ T-cells'
cd4_cluster[,colnames(cd4_cluster) %in% 
                      colnames(cd3low_cluster[,cd3low_cluster$Label %in% c('PD1+ CD28+ CD3-low CD4 T cells')])]$Label = 'CD4+ Tregs'
cd4_cluster[,colnames(cd4_cluster) %in% 
                      colnames(cd3low_cluster[,cd3low_cluster$Label %in% c('CD16+ CD3-low CD4 T cells')])]$Label = 'CD16+ CD4+ T-cells'
cd4_cluster[,colnames(cd4_cluster) %in% 
                      colnames(cd3low_cluster[,cd3low_cluster$Label %in% c('HLADR+ CD3-low CD4 T cells')])]$Label = 'Activated CD4+ T-cells'


unique(cd4_cluster$Label)
```


CD8+ T Cell Population

```{r}
cd8_cluster = sce_adult_labelled[, sce_adult_labelled$Clusters == 'CD8+ T-cells']

markers = c('CD28','CD16','CD11b','CD45','CD8','CD279','Foxp3',
            'Ki67','CD3','HLADR','GranzymeB')

set.seed(88)
cd8_cluster = CATALYST::cluster(cd8_cluster, features = markers, 
                                xdim = 3, ydim = 3, maxK = 5, seed = 88)

# Heatmap
marker_expression <- data.frame(t(assay(cd8_cluster[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(cd8_cluster)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix(t(dat_aggr[,-c(1)]))
colnames(m) <- dat_aggr$cluster_id

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = "'"),
                                              which = "column",
                                              rot = 90,
                                              just = "center",
                                              height = unit(2.3,"cm"),
                                              location = 0.5,
                                              gp = gpar(fontsize=16,col = "black", border = "black")))

cd8_subclusters_flowsom = Heatmap(m, name = "Expression",
                                  cluster_columns = TRUE,
                                  show_column_dend = TRUE,
                                  cluster_rows = FALSE,
                                  show_row_dend = FALSE,
                                  column_names_rot = 45,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  top_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(15,"cm"))

draw(cd8_subclusters_flowsom, heatmap_legend_side = "bottom")

# Annotate and combine clusters

cd8_cluster$Label = NA
cd8_cluster[,cd8_cluster$cluster_id == 1]$Label = "CD4+ Tregs"
cd8_cluster[,cd8_cluster$cluster_id %in% c(2,3,5,7)]$Label = "CD8 T cells"
cd8_cluster[,cd8_cluster$cluster_id == 4]$Label = "PD1+CD28+ CD8 T cells"
cd8_cluster[,cd8_cluster$cluster_id == 6]$Label = "Cytotoxic T cells"
cd8_cluster[,cd8_cluster$cluster_id == 8]$Label = "PD1+ CD8 T cells"
cd8_cluster[,cd8_cluster$cluster_id == 9]$Label = "Proliferating CD8 T cells"

unique(cd8_cluster$Label)
```

B Cell Population

```{r}
bcell_cluster = sce_adult_labelled[, sce_adult_labelled$Clusters == 'B cells']

markers = c('CD45','CD20','CD279','Foxp3','Ki67','HLADR')

set.seed(88)
bcell_cluster = CATALYST::cluster(bcell_cluster, features = markers, 
                                xdim = 3, ydim = 3, maxK = 5, seed = 88)

# Heatmap
marker_expression <- data.frame(t(assay(bcell_cluster[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(bcell_cluster)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix(t(dat_aggr[,-c(1)]))
colnames(m) <- dat_aggr$cluster_id

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = "'"),
                                              which = "column",
                                              rot = 90,
                                              just = "center",
                                              height = unit(2.3,"cm"),
                                              location = 0.5,
                                              gp = gpar(fontsize=16,col = "black", border = "black")))

bcell_subclusters_flowsom = Heatmap(m, name = "Expression",
                                  cluster_columns = TRUE,
                                  show_column_dend = TRUE,
                                  cluster_rows = FALSE,
                                  show_row_dend = FALSE,
                                  column_names_rot = 45,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  top_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(15,"cm"))

draw(bcell_subclusters_flowsom, heatmap_legend_side = "bottom")

# Annotate and combine clusters

bcell_cluster$Label = NA
bcell_cluster[,bcell_cluster$cluster_id %in% c(1,5)]$Label = "CD4+ Tregs"
bcell_cluster[,bcell_cluster$cluster_id %in% c(4,7)]$Label = "PD1+ B cells"
bcell_cluster[,bcell_cluster$cluster_id == 8]$Label = "Proliferating B cells"
bcell_cluster[,bcell_cluster$cluster_id %in% c(2,3,6,9)]$Label = "B cells"

unique(bcell_cluster$Label)
```

Macrophage Population

```{r}
macrophages_cluster = sce_adult_labelled[, sce_adult_labelled$Clusters == 'Macrophages']

#################################
# First separate into M1 and M2 #
#################################

markers = c('CD16','CD11b','CD45','Foxp3','CD163','CD68','Ki67','HLADR')

scaled_macrophages_cluster = as.data.frame(scale(t(assay(macrophages_cluster[rownames(macrophages_cluster) %in% 
                                                                     markers,],'exprs'))))
head(scaled_macrophages_cluster)

scaled_macrophages_cluster = scaled_macrophages_cluster %>% mutate(Label = case_when(
  (CD163>0) ~ 'M2 Macrophages',
  T ~ 'M1 Macrophages'
))

head(scaled_macrophages_cluster)

macrophages_cluster$cluster_id = scaled_macrophages_cluster$Label

####################
# M1 SUBCLUSTERING #
####################

m1_clusters = macrophages_cluster[,macrophages_cluster$cluster_id %in% c('M1 Macrophages')]

markers = c('CD16','CD11b','CD45','Foxp3','CD68','Ki67','HLADR')

set.seed(88)
m1_clusters = CATALYST::cluster(m1_clusters, features = markers, 
                                xdim = 3, ydim = 3, maxK = 5, seed = 88)

# Heatmap
marker_expression <- data.frame(t(assay(m1_clusters[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(m1_clusters)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix(t(dat_aggr[,-c(1)]))
colnames(m) <- dat_aggr$cluster_id

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = "'"),
                                              which = "column",
                                              rot = 90,
                                              just = "center",
                                              height = unit(2.3,"cm"),
                                              location = 0.5,
                                              gp = gpar(fontsize=16,col = "black", border = "black")))

m1_subclusters_flowsom = Heatmap(m, name = "Expression",
                                  cluster_columns = TRUE,
                                  show_column_dend = TRUE,
                                  cluster_rows = FALSE,
                                  show_row_dend = FALSE,
                                  column_names_rot = 45,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  top_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(15,"cm"))

draw(m1_subclusters_flowsom, heatmap_legend_side = "bottom")

####################
# M2 SUBCLUSTERING #
####################

m2_clusters = macrophages_cluster[,macrophages_cluster$cluster_id %in% c('M2 Macrophages')]

markers = c('CD16','CD11b','CD45','Foxp3','CD163','CD68','Ki67','HLADR')

set.seed(88)
m2_clusters = CATALYST::cluster(m2_clusters, features = markers, 
                                xdim = 3, ydim = 3, maxK = 5, seed = 88)

# Heatmap
marker_expression <- data.frame(t(assay(m2_clusters[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(m2_clusters)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix(t(dat_aggr[,-c(1)]))
colnames(m) <- dat_aggr$cluster_id

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = "'"),
                                              which = "column",
                                              rot = 90,
                                              just = "center",
                                              height = unit(2.3,"cm"),
                                              location = 0.5,
                                              gp = gpar(fontsize=16,col = "black", border = "black")))

m2_subclusters_flowsom = Heatmap(m, name = "Expression",
                                  cluster_columns = TRUE,
                                  show_column_dend = TRUE,
                                  cluster_rows = FALSE,
                                  show_row_dend = FALSE,
                                  column_names_rot = 45,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  top_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(15,"cm"))

draw(m2_subclusters_flowsom, heatmap_legend_side = "bottom")

#################################
# Annotate clusters and combine #
#################################

m1_clusters$Label = NA

m1_clusters[,m1_clusters$cluster_id == 1]$Label = "CD16+ M1 macrophages"
m1_clusters[,m1_clusters$cluster_id %in% c(2,3,4,8,9)]$Label = "M1 macrophages"
m1_clusters[,m1_clusters$cluster_id == 5]$Label = "CD4 Treg cells"
m1_clusters[,m1_clusters$cluster_id == 6]$Label = "CD11b+ M1 macrophages"
m1_clusters[,m1_clusters$cluster_id == 7]$Label = "Proliferating M1 macrophages"

unique(m1_clusters$Label)


m2_clusters$Label = NA

m2_clusters[,m2_clusters$cluster_id == 1]$Label = "CD4 Treg cells"
m2_clusters[,m2_clusters$cluster_id %in% c(2,3)]$Label = "M2 macrophages"
m2_clusters[,m2_clusters$cluster_id == 4]$Label = "Proliferating M2 macrophages"
m2_clusters[,m2_clusters$cluster_id %in% c(5,7,8)]$Label = "CD16+ M2 macrophages"
m2_clusters[,m2_clusters$cluster_id == 6]$Label = "CD11b+ M2 macrophages"
m2_clusters[,m2_clusters$cluster_id == 9]$Label = "HLADR+ M2 macrophages"

unique(m2_clusters$Label)


#####################
# COMBINE M1 AND M2 #
#####################

unique(m1_clusters$Label)

macrophages_cluster$Label = NA
macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m1_clusters[,m1_clusters$Label %in% c('M1 macrophages')])]$Label = 'M1 macrophages'
macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m1_clusters[,m1_clusters$Label %in% c('CD4 Treg cells')])]$Label = 'CD4+ Tregs'
macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m1_clusters[,m1_clusters$Label %in% c('Proliferating M1 macrophages')])]$Label = 'Proliferating M1 macrophages'
macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m1_clusters[,m1_clusters$Label %in% c('CD11b+ M1 macrophages')])]$Label = 'CD11b+ M1 macrophages'
macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m1_clusters[,m1_clusters$Label %in% c('CD16+ M1 macrophages')])]$Label = 'CD16+ M1 macrophages'

unique(m2_clusters$Label)

macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m2_clusters[,m2_clusters$Label %in% c('M2 macrophages')])]$Label = 'M2 macrophages'
macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m2_clusters[,m2_clusters$Label %in% c('CD4 Treg cells')])]$Label = 'CD4+ Tregs'
macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m2_clusters[,m2_clusters$Label %in% c('Proliferating M2 macrophages')])]$Label = 'Proliferating M2 macrophages'
macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m2_clusters[,m2_clusters$Label %in% c('CD11b+ M2 macrophages')])]$Label = 'CD11b+ M2 macrophages'
macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m2_clusters[,m2_clusters$Label %in% c('CD16+ M2 macrophages')])]$Label = 'CD16+ M2 macrophages'
macrophages_cluster[,colnames(macrophages_cluster) %in% 
                      colnames(m2_clusters[,m2_clusters$Label %in% c('HLADR+ M2 macrophages')])]$Label = 'HLADR+ M2 macrophages'

unique(macrophages_cluster$Label)
```

Monocyte Population

```{r}
monocytes_cluster = sce_adult_labelled[, sce_adult_labelled$Clusters == 'Monocytes']

markers = c('CD16','CD11b','CD45','Foxp3','CD163','CD68','Ki67','HLADR')

set.seed(88)
monocytes_cluster = CATALYST::cluster(monocytes_cluster, features = markers, 
                                        xdim = 3, ydim = 3, maxK = 5, seed = 88)

# Heatmap
marker_expression <- data.frame(t(assay(monocytes_cluster[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(monocytes_cluster)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix(t(dat_aggr[,-c(1)]))
colnames(m) <- dat_aggr$cluster_id

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = "'"),
                                              which = "column",
                                              rot = 90,
                                              just = "center",
                                              height = unit(2.3,"cm"),
                                              location = 0.5,
                                              gp = gpar(fontsize=16,col = "black", border = "black")))

monocytes_subclusters_flowsom = Heatmap(m, name = "Expression",
                                          cluster_columns = TRUE,
                                          show_column_dend = TRUE,
                                          cluster_rows = FALSE,
                                          show_row_dend = FALSE,
                                          column_names_rot = 45,
                                          column_names_centered = FALSE,
                                          show_column_names = TRUE,
                                          row_title_gp = gpar(fontsize = 23),
                                          top_annotation = ha,
                                          col = colorRamp2(c(0, 2), c("white", "red")),
                                          column_names_side = "bottom",
                                          height = unit(8, "cm"),
                                          width = unit(15,"cm"))

draw(monocytes_subclusters_flowsom, heatmap_legend_side = "bottom")


# Annotate clusters and combine

monocytes_cluster$Label = NA
monocytes_cluster[,monocytes_cluster$cluster_id %in% c(1,2,5,6,9)]$Label = "Classical monocytes"
monocytes_cluster[,monocytes_cluster$cluster_id == 3]$Label = "CD4+ Tregs"
monocytes_cluster[,monocytes_cluster$cluster_id == 4]$Label = "Intermediate monocytes"
monocytes_cluster[,monocytes_cluster$cluster_id == 7]$Label = "Non-classical monocytes"
monocytes_cluster[,monocytes_cluster$cluster_id == 8]$Label = "Activated monocytes"

unique(monocytes_cluster$Label)
```

Hepatocytes

```{r}
hepatocytes_cluster = sce_adult_labelled[, sce_adult_labelled$Clusters == 'Hepatocytes']

markers = c('Ki67','HLADR')

set.seed(88)
hepatocytes_cluster = CATALYST::cluster(hepatocytes_cluster, features = markers, 
                                        xdim = 3, ydim = 3, maxK = 3, seed = 88)

# Heatmap
marker_expression <- data.frame(t(assay(hepatocytes_cluster[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(hepatocytes_cluster)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix(t(dat_aggr[,-c(1)]))
colnames(m) <- dat_aggr$cluster_id

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = "'"),
                                              which = "column",
                                              rot = 90,
                                              just = "center",
                                              height = unit(2.3,"cm"),
                                              location = 0.5,
                                              gp = gpar(fontsize=16,col = "black", border = "black")))

hepatocytes_subclusters_flowsom = Heatmap(m, name = "Expression",
                                          cluster_columns = TRUE,
                                          show_column_dend = TRUE,
                                          cluster_rows = FALSE,
                                          show_row_dend = FALSE,
                                          column_names_rot = 45,
                                          column_names_centered = FALSE,
                                          show_column_names = TRUE,
                                          row_title_gp = gpar(fontsize = 23),
                                          top_annotation = ha,
                                          col = colorRamp2(c(0, 2), c("white", "red")),
                                          column_names_side = "bottom",
                                          height = unit(8, "cm"),
                                          width = unit(15,"cm"))

draw(hepatocytes_subclusters_flowsom, heatmap_legend_side = "bottom")

# Annotate clusters and combine

hepatocytes_cluster$Label = NA
hepatocytes_cluster[,hepatocytes_cluster$cluster_id %in% c(6,7,8)]$Label = "Proliferating Hepatocytes"
hepatocytes_cluster[,hepatocytes_cluster$cluster_id %in% c(1,2,4,5)]$Label = "HLADR+ Hepatocytes"
hepatocytes_cluster[,hepatocytes_cluster$cluster_id %in% c(3,9)]$Label = "Hepatocytes"

unique(hepatocytes_cluster$Label)
```

Cholangiocytes

```{r}
cholangiocytes_cluster = sce_adult_labelled[, sce_adult_labelled$Clusters == 'Cholangiocytes']

markers = c('CK7','Ki67','HLADR')

set.seed(88)
cholangiocytes_cluster = CATALYST::cluster(cholangiocytes_cluster, features = markers, 
                                        xdim = 3, ydim = 3, maxK = 3, seed = 88)

# Heatmap
marker_expression <- data.frame(t(assay(cholangiocytes_cluster[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(cholangiocytes_cluster)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix(t(dat_aggr[,-c(1)]))
colnames(m) <- dat_aggr$cluster_id

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = "'"),
                                              which = "column",
                                              rot = 90,
                                              just = "center",
                                              height = unit(2.3,"cm"),
                                              location = 0.5,
                                              gp = gpar(fontsize=16,col = "black", border = "black")))

cholangiocytes_subclusters_flowsom = Heatmap(m, name = "Expression",
                                          cluster_columns = TRUE,
                                          show_column_dend = TRUE,
                                          cluster_rows = FALSE,
                                          show_row_dend = FALSE,
                                          column_names_rot = 45,
                                          column_names_centered = FALSE,
                                          show_column_names = TRUE,
                                          row_title_gp = gpar(fontsize = 23),
                                          top_annotation = ha,
                                          col = colorRamp2(c(0, 2), c("white", "red")),
                                          column_names_side = "bottom",
                                          height = unit(8, "cm"),
                                          width = unit(15,"cm"))

draw(cholangiocytes_subclusters_flowsom, heatmap_legend_side = "bottom")

# Annotate clusters and combine

cholangiocytes_cluster$Label = NA
cholangiocytes_cluster[,cholangiocytes_cluster$cluster_id %in% c(2)]$Label = "Proliferating Cholangiocytes"
cholangiocytes_cluster[,cholangiocytes_cluster$cluster_id %in% c(6)]$Label = "HLADR+ Cholangiocytes"
cholangiocytes_cluster[,cholangiocytes_cluster$cluster_id %in% c(1,3,4,5,7,8,9)]$Label = "Cholangiocytes"

unique(cholangiocytes_cluster$Label)
```

Endothelial cells

```{r}
endothelial_cluster = sce_adult_labelled[, sce_adult_labelled$Clusters == 'Endothelial cells']

markers = c('CD31','Ki67','HLADR')

set.seed(88)
endothelial_cluster = CATALYST::cluster(endothelial_cluster, features = markers, 
                                        xdim = 3, ydim = 3, maxK = 3, seed = 88)

# Heatmap
marker_expression <- data.frame(t(assay(endothelial_cluster[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(endothelial_cluster)[,"cluster_id"])
colnames(dat) = "cluster_id"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(cluster_id) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(cluster_id) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix(t(dat_aggr[,-c(1)]))
colnames(m) <- dat_aggr$cluster_id

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = "'"),
                                              which = "column",
                                              rot = 90,
                                              just = "center",
                                              height = unit(2.3,"cm"),
                                              location = 0.5,
                                              gp = gpar(fontsize=16,col = "black", border = "black")))

endothelial_subclusters_flowsom = Heatmap(m, name = "Expression",
                                          cluster_columns = TRUE,
                                          show_column_dend = TRUE,
                                          cluster_rows = FALSE,
                                          show_row_dend = FALSE,
                                          column_names_rot = 45,
                                          column_names_centered = FALSE,
                                          show_column_names = TRUE,
                                          row_title_gp = gpar(fontsize = 23),
                                          top_annotation = ha,
                                          col = colorRamp2(c(0, 2), c("white", "red")),
                                          column_names_side = "bottom",
                                          height = unit(8, "cm"),
                                          width = unit(15,"cm"))

draw(endothelial_subclusters_flowsom, heatmap_legend_side = "bottom")

# Annotate clusters and combine

endothelial_cluster$Label = NA
endothelial_cluster[,endothelial_cluster$cluster_id %in% c(9)]$Label = "Proliferating Endothelial cells"
endothelial_cluster[,endothelial_cluster$cluster_id %in% c(5,8)]$Label = "HLADR+ Endothelial cells"
endothelial_cluster[,endothelial_cluster$cluster_id %in% c(1,2,3,4,6,7)]$Label = "Endothelial cells"

unique(endothelial_cluster$Label)
```

# Incorporate subclusters into main SCE object

```{r}
sce_adult_labelled$Subcluster = NA

# CD4 Subclusters
unique(cd4_cluster$Label)
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd4_cluster[,cd4_cluster$Label=='CD4+ T-cells'])]$Subcluster = 'CD3+ CD4+ T-cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd4_cluster[,cd4_cluster$Label=='CD4+ Tregs'])]$Subcluster = 'CD4+ Tregs'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd4_cluster[,cd4_cluster$Label=='Ki67+ CD4+ T-cells'])]$Subcluster = 'Proliferating CD4+ T-cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd4_cluster[,cd4_cluster$Label=='PD1+ CD4+ T-cells'])]$Subcluster = 'PD1+ CD4+ T-cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd4_cluster[,cd4_cluster$Label=='Naive CD4+ T-cells'])]$Subcluster = 'Naive CD4+ T-cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd4_cluster[,cd4_cluster$Label=='Activated CD4+ T-cells'])]$Subcluster = 'Activated CD4+ T-cells'

sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd4_cluster[,cd4_cluster$Label=='Resident memory CD4+ T-cells'])]$Subcluster = 'Resident memory CD4+ T-cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd4_cluster[,cd4_cluster$Label=='CD16+ CD4+ T-cells'])]$Subcluster = 'CD16+ CD4+ T-cells'


# CD8 Subclusters
unique(cd8_cluster$Label)
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd8_cluster[,cd8_cluster$Label=='CD8 T cells'])]$Subcluster = 'CD3+ CD8+ T-cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd8_cluster[,cd8_cluster$Label=='CD4+ Tregs'])]$Subcluster = 'CD4+ Tregs'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd8_cluster[,cd8_cluster$Label=='Proliferating CD8 T cells'])]$Subcluster = 'Proliferating CD8+ T-cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd8_cluster[,cd8_cluster$Label=='Cytotoxic T cells'])]$Subcluster = 'Cytotoxic T-cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd8_cluster[,cd8_cluster$Label=='PD1+ CD8 T cells'])]$Subcluster = 'PD1+ CD8+ T-cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cd8_cluster[,cd8_cluster$Label=='PD1+CD28+ CD8 T cells'])]$Subcluster = 'PD1+CD28+ CD8+ T-cells'


# B Cells Subclusters
unique(bcell_cluster$Label)
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(bcell_cluster[,bcell_cluster$Label=='B cells'])]$Subcluster = 'B cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(bcell_cluster[,bcell_cluster$Label=='CD4+ Tregs'])]$Subcluster = 'CD4+ Tregs'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(bcell_cluster[,bcell_cluster$Label=='Proliferating B cells'])]$Subcluster = 'Proliferating B cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(bcell_cluster[,bcell_cluster$Label=='PD1+ B cells'])]$Subcluster = 'PD1+ B cells'


# Macrophage Subclusters
unique(macrophages_cluster$Label)
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='M1 macrophages'])]$Subcluster = 'M1 macrophages'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='M2 macrophages'])]$Subcluster = 'M2 macrophages'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='CD4+ Tregs'])]$Subcluster = 'CD4+ Tregs'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='Proliferating M1 macrophages'])]$Subcluster = 'Proliferating M1 macrophages'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='Proliferating M2 macrophages'])]$Subcluster = 'Proliferating M2 macrophages'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='CD11b+ M1 macrophages'])]$Subcluster = 'CD11b+ M1 macrophages'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='CD11b+ M2 macrophages'])]$Subcluster = 'CD11b+ M2 macrophages'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='CD16+ M1 macrophages'])]$Subcluster = 'CD16+ M1 macrophages'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='CD16+ M2 macrophages'])]$Subcluster = 'CD16+ M2 macrophages'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(macrophages_cluster[,macrophages_cluster$Label=='HLADR+ M2 macrophages'])]$Subcluster = 'HLADR+ M2 macrophages'


# Monocytes Subclusters
unique(monocytes_cluster$Label)
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(monocytes_cluster[,monocytes_cluster$Label=='Non-classical monocytes'])]$Subcluster = 'Non-classical monocytes'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(monocytes_cluster[,monocytes_cluster$Label=='Classical monocytes'])]$Subcluster = 'Classical monocytes'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(monocytes_cluster[,monocytes_cluster$Label=='Intermediate monocytes'])]$Subcluster = 'Intermediate monocytes'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(monocytes_cluster[,monocytes_cluster$Label=='CD4+ Tregs'])]$Subcluster = 'CD4+ Tregs'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(monocytes_cluster[,monocytes_cluster$Label=='Activated monocytes'])]$Subcluster = 'Activated monocytes'

unique(sce_adult_labelled$Subcluster)


# Hepatocytes Subclusters
unique(hepatocytes_cluster$Label)
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(hepatocytes_cluster[,hepatocytes_cluster$Label=='Hepatocytes'])]$Subcluster = 'Hepatocytes'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(hepatocytes_cluster[,hepatocytes_cluster$Label=='HLADR+ Hepatocytes'])]$Subcluster = 'HLADR+ Hepatocytes'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(hepatocytes_cluster[,hepatocytes_cluster$Label=='Proliferating Hepatocytes'])]$Subcluster = 'Proliferating Hepatocytes'


# Cholangiocytes Subclusters
unique(cholangiocytes_cluster$Label)
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cholangiocytes_cluster[,cholangiocytes_cluster$Label=='Cholangiocytes'])]$Subcluster = 'Cholangiocytes'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cholangiocytes_cluster[,cholangiocytes_cluster$Label=='Proliferating Cholangiocytes'])]$Subcluster = 'Proliferating Cholangiocytes'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(cholangiocytes_cluster[,cholangiocytes_cluster$Label=='HLADR+ Cholangiocytes'])]$Subcluster = 'HLADR+ Cholangiocytes'


# Endothelial cells Subclusters
unique(endothelial_cluster$Label)
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(endothelial_cluster[,endothelial_cluster$Label=='Endothelial cells'])]$Subcluster = 'Endothelial cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(endothelial_cluster[,endothelial_cluster$Label=='HLADR+ Endothelial cells'])]$Subcluster = 'HLADR+ Endothelial cells'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(endothelial_cluster[,endothelial_cluster$Label=='Proliferating Endothelial cells'])]$Subcluster = 'Proliferating Endothelial cells'


# Add remaining clusters
sce_adult_labelled[,sce_adult_labelled$Clusters == 'Neutrophils']$Subcluster = 'Neutrophils'
sce_adult_labelled[,sce_adult_labelled$Clusters == 'Plasma cells']$Subcluster = 'Plasma cells'

colData(sce_adult_labelled)
unique(sce_adult_labelled$Subcluster)

# Change Cluster for those CD4+ Tregs that weren't identified as CD4 cells
colData(sce_adult_labelled[,sce_adult_labelled$Subcluster=='CD4+ Tregs'])
sce_adult_labelled[,sce_adult_labelled$Subcluster=='CD4+ Tregs']$Clusters = 'CD4+ T-cells'
```

Separate CD4+ Tregs into HLADR+ and HLADR-

```{r}
tregs_cluster = sce_adult_labelled[, sce_adult_labelled$Subcluster == 'CD4+ Tregs']

markers = c('CD28','CD16','CD11b','CD45','CD4','CD279','Foxp3','Ki67','CD3','HLADR')

#Separate into HLADR high and HLADR low
df_treg_cluster = as.data.frame((t(assay(tregs_cluster[rownames(tregs_cluster) %in% markers,],'exprs'))))
head(df_treg_cluster)

df_treg_cluster = df_treg_cluster %>% mutate(Label = case_when(
  (HLADR>0) ~ 'HLADR+',
  T ~ 'HLADR-'
))

head(df_treg_cluster)

tregs_cluster$cluster_id = df_treg_cluster$Label

# Incorporate into main SCE object
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(tregs_cluster[,tregs_cluster$cluster_id=='HLADR+'])]$Subcluster = 'HLADR+ CD4+ Tregs'
sce_adult_labelled[,colnames(sce_adult_labelled) %in% 
                     colnames(tregs_cluster[,tregs_cluster$cluster_id=='HLADR-'])]$Subcluster = 'HLADR- CD4+ Tregs'

unique(sce_adult_labelled$Subcluster)
```

# FINAL METACLUSTER HEATMAP

```{r}
markers_to_include = c('CD66b','CD20','CD163','CD11b','CD4','CD31','CD68','CK7','CD8','CD138')

marker_expression <- data.frame(t(assay(sce_adult_labelled[markers_to_include,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(sce_adult_labelled)[,"Clusters"])
colnames(dat) = "Clusters"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(Clusters) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(Clusters) %>%
  dplyr::summarise(n=n())

rownames(dat_sum) = dat_sum$Clusters
dat_sum = dat_sum[c('Hepatocytes','Cholangiocytes','Endothelial cells','CD4+ T-cells',
                    'CD8+ T-cells','Macrophages','Monocytes','Neutrophils','B cells','Plasma cells'),]

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Clusters

m = m[c('Hepatocytes','Cholangiocytes','Endothelial cells','CD4+ T-cells',
        'CD8+ T-cells','Macrophages','Monocytes','Neutrophils','B cells','Plasma cells'),]

m = m[,c('CK7','CD31','CD4','CD8','CD68','CD163','CD11b','CD66b','CD20','CD138')]

ha_right <- rowAnnotation(" " = anno_barplot((as.numeric(dat_sum[2,])),
                                                     add_numbers = TRUE,numbers_gp = gpar(fontsize = 20),
                                                     which = "row",
                                                     numbers_rot=0,
                                                     ylim=c(0,300000),
                                                     axis=FALSE,
                                                     border=FALSE,
                                                     width = unit(3, "cm")))


col_fun = colorRamp2(c(1,2,3,4,5,6,7,8,9,10), 
                     c("lightblue","#C04000","#313695",
                      "#FFEA00", "orange","#0096FF","green",
                       "#ae017e","#bf812d", "#CCCCFF"))
ha_left = HeatmapAnnotation(Metaclusters = 1:10, col = list(Metaclusters = col_fun), annotation_name_rot=45, 
                            annotation_name_gp=gpar(fontsize=25),gp = gpar(col = "black"), 
                            which='row', show_legend = FALSE)

metaclusters_2 = Heatmap(m, name = "Scaled expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = FALSE,
                                  show_row_dend = FALSE,
                                  column_names_rot = 45,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23), #23
                                  row_names_gp = gpar(fontsize = 25),
                                  column_names_gp = gpar(fontsize = 25),
                                  right_annotation = ha_right,
                                  left_annotation = ha_left,
                                  rect_gp = gpar(col = "white", lwd = 2),
                                  col = colorRamp2(c(-1, 0, 2), hcl_palette='viridis'),
                                  heatmap_legend_param = list(at = c(-1:2), legend_width = unit(6,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=12),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  row_names_side = 'left',
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(metaclusters_2, heatmap_legend_side = "top")
```

# Heatmap Visualization of Subclusters

```{r}
###################
# All subclusters #
###################

markers_to_include = c('CD66b','CD20','CD28','CD16','CD163','CD11b','CD45',
                       'CD4','CD31','CD279','CD68','Foxp3',
                       'CK7','Ki67','CD8',
                       'CD3','CD138','HLADR','GranzymeB')

# Non-immune

subclusters_nonimmune = sce_adult_labelled[,sce_adult_labelled$Subcluster %in% 
                                             c('Hepatocytes','Endothelial cells','Cholangiocytes')]

marker_expression <- data.frame(t(assay(subclusters_nonimmune[markers_to_include,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(subclusters_nonimmune)[,"Subcluster"])
colnames(dat) = "Subcluster"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(Subcluster) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(Subcluster) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Subcluster

ha_right <- rowAnnotation(" " = anno_barplot((as.numeric(dat_sum[2,])),
                                                     add_numbers = TRUE,
                                                     which = "row",
                                                     numbers_rot=0,
                                                     ylim=c(0,300000),
                                                     axis=FALSE,
                                                     border=FALSE,
                                                     width = unit(3, "cm")))

col_fun = colorRamp2(c(1,2,3),
                     c("#C04000","#313695","lightblue"))

ha_left = HeatmapAnnotation(Metaclusters = 1:3, col = list(Metaclusters = col_fun),
                            gp = gpar(col = "black"), which='row', show_legend = FALSE)

subclusters = Heatmap(m, name = "Scaled expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = FALSE,
                                  show_row_dend = FALSE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 20),
                                  right_annotation = ha_right,
                                  left_annotation = ha_left,
                                  rect_gp = gpar(col = "white", lwd = 2),
                                  col = colorRamp2(c(-1, 0, 2), hcl_palette='viridis'),
                                  heatmap_legend_param = list(at = c(-1:2), legend_width = unit(6,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  row_names_side = 'left',
                                  height = unit(1.5, "cm"),
                                  width = unit(18,"cm")
                      )

draw(subclusters, heatmap_legend_side = "bottom")

tiff("Heatmap_all_subclusters_nonimmune.tiff", units="in", width=13, height=10, res=300)
draw(subclusters, heatmap_legend_side = "bottom")
dev.off()

# Immune

subclusters_immune = sce_adult_labelled[,!sce_adult_labelled$Subcluster %in% 
                                             c('Hepatocytes','Endothelial cells','Cholangiocytes')]

marker_expression <- data.frame(t(assay(subclusters_immune[markers_to_include,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(subclusters_immune)[,"Subcluster"])
colnames(dat) = "Subcluster"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(Subcluster) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(Subcluster) %>%
  dplyr::summarise(n=n())

rownames(dat_sum) = dat_sum$Subcluster
dat_sum = dat_sum[c('B cells','Proliferating B cells','PD1+ B cells',
        'CD3+ CD4+ T-cells','Resident memory CD4+ T-cells','Naive CD4+ T-cells',
            'HLADR+ CD4+ Tregs','HLADR- CD4+ Tregs','PD1+ CD4+ T-cells','Proliferating CD4+ T-cells',
            'Activated CD4+ T-cells','CD16+ CD4+ T-cells',
            'CD3+ CD8+ T-cells','Cytotoxic T-cells','Proliferating CD8+ T-cells',
            'PD1+ CD8+ T-cells','PD1+CD28+ CD8+ T-cells',
            'M1 macrophages','Proliferating M1 macrophages','CD11b+ M1 macrophages','CD16+ M1 macrophages',
            'M2 macrophages','Proliferating M2 macrophages','CD11b+ M2 macrophages',
            'CD16+ M2 macrophages','HLADR+ M2 macrophages',
            'Classical monocytes','Non-classical monocytes','Intermediate monocytes','Activated monocytes',
            'Neutrophils','Plasma cells'),]

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Subcluster

m = m[c('B cells','Proliferating B cells','PD1+ B cells',
        'CD3+ CD4+ T-cells','Resident memory CD4+ T-cells','Naive CD4+ T-cells',
            'HLADR+ CD4+ Tregs','HLADR- CD4+ Tregs','PD1+ CD4+ T-cells','Proliferating CD4+ T-cells',
            'Activated CD4+ T-cells','CD16+ CD4+ T-cells',
            'CD3+ CD8+ T-cells','Cytotoxic T-cells','Proliferating CD8+ T-cells',
            'PD1+ CD8+ T-cells','PD1+CD28+ CD8+ T-cells',
            'M1 macrophages','Proliferating M1 macrophages','CD11b+ M1 macrophages','CD16+ M1 macrophages',
            'M2 macrophages','Proliferating M2 macrophages','CD11b+ M2 macrophages',
            'CD16+ M2 macrophages','HLADR+ M2 macrophages',
            'Classical monocytes','Non-classical monocytes','Intermediate monocytes','Activated monocytes',
            'Neutrophils','Plasma cells'),]

dat_sum[,1]

ha_right <- rowAnnotation(" " = anno_barplot((as.numeric(dat_sum[2,])),
                                                     add_numbers = TRUE,
                                                     which = "row",
                                                     numbers_rot=0,
                                                     ylim=c(0,35000),
                                                     axis=FALSE,
                                                     border=FALSE,
                                                     width = unit(3, "cm")))

col_fun = colorRamp2(c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32),
                     c("#bf812d","#bf812d","#bf812d",
                       "#FFEA00","#FFEA00","#FFEA00","#FFEA00","#FFEA00","#FFEA00","#FFEA00","#FFEA00","#FFEA00",
                       "orange","orange","orange","orange","orange",
                       "#0096FF","#0096FF","#0096FF","#0096FF","#0096FF","#0096FF","#0096FF","#0096FF","#0096FF",
                       "green","green","green","green","#ae017e","#CCCCFF"))
                   
ha_left = HeatmapAnnotation(Metaclusters = 1:32, col = list(Metaclusters = col_fun),
                            gp = gpar(col = "black"), which='row', show_legend = FALSE)

subclusters = Heatmap(m, name = "Scaled expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = FALSE,
                                  show_row_dend = FALSE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  right_annotation = ha_right,
                                  left_annotation = ha_left,
                                  rect_gp = gpar(col = "white", lwd = 2),
                                  col = colorRamp2(c(-1, 0, 2), hcl_palette='viridis'),
                                  heatmap_legend_param = list(at = c(-1:2), legend_width = unit(6,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  row_names_side = 'left',
                                  height = unit(18, "cm"), 
                                  width = unit(20,"cm")
                      )

draw(subclusters, heatmap_legend_side = "bottom")

tiff("Heatmap_all_subclusters_immune.tiff", units="in", width=13, height=10, res=300)
draw(subclusters, heatmap_legend_side = "bottom")
dev.off()


###############
# CD4 T cells #
###############

temp_sce = sce_adult_labelled[,sce_adult_labelled$Clusters=='CD4+ T-cells']
markers = c('CD28','CD16','CD11b','CD45','CD4','CD279','Foxp3','Ki67','CD3','HLADR')

marker_expression <- data.frame(t(assay(temp_sce[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(temp_sce)[,"Subcluster"])
colnames(dat) = "Subcluster"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(Subcluster) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(Subcluster) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Subcluster

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = ","),
                                              which = "row",
                                              rot = 0,
                                              just = "right",
                                              width = unit(2,"cm"),
                                              location = 0.9,
                                              gp = gpar(fontsize=14,col = "black", border = "black")),
                        which = "row")
subclusters_labelled = Heatmap(m, name = "Expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = TRUE,
                                  show_row_dend = TRUE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  left_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(subclusters_labelled, heatmap_legend_side = "bottom")

###############
# CD8 T cells #
###############

temp_sce = sce_adult_labelled[,sce_adult_labelled$Clusters=='CD8+ T-cells']
markers = c('CD28','CD16','CD11b','CD45','CD8','CD279','Foxp3','Ki67','CD3','HLADR','GranzymeB')

marker_expression <- data.frame(t(assay(temp_sce[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(temp_sce)[,"Subcluster"])
colnames(dat) = "Subcluster"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(Subcluster) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(Subcluster) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Subcluster

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = ","),
                                              which = "row",
                                              rot = 0,
                                              just = "right",
                                              width = unit(2,"cm"),
                                              location = 0.9,
                                              gp = gpar(fontsize=14,col = "black", border = "black")),
                        which = "row")
subclusters_labelled = Heatmap(m, name = "Expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = TRUE,
                                  show_row_dend = TRUE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  left_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(subclusters_labelled, heatmap_legend_side = "bottom")

###########
# B cells #
###########

temp_sce = sce_adult_labelled[,sce_adult_labelled$Clusters=='B cells']
markers = c('CD45','CD20','CD279','Foxp3','Ki67','HLADR')

marker_expression <- data.frame(t(assay(temp_sce[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(temp_sce)[,"Subcluster"])
colnames(dat) = "Subcluster"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(Subcluster) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(Subcluster) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Subcluster

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = ","),
                                              which = "row",
                                              rot = 0,
                                              just = "right",
                                              width = unit(2,"cm"),
                                              location = 0.9,
                                              gp = gpar(fontsize=14,col = "black", border = "black")),
                        which = "row")
subclusters_labelled = Heatmap(m, name = "Expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = TRUE,
                                  show_row_dend = TRUE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  left_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(subclusters_labelled, heatmap_legend_side = "bottom")

###############
# Macrophages #
###############

temp_sce = sce_adult_labelled[,sce_adult_labelled$Clusters=='Macrophages']
markers = c('CD16','CD11b','CD45','Foxp3','CD163','CD68','Ki67','HLADR')

marker_expression <- data.frame(t(assay(temp_sce[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(temp_sce)[,"Subcluster"])
colnames(dat) = "Subcluster"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(Subcluster) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(Subcluster) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Subcluster

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = ","),
                                              which = "row",
                                              rot = 0,
                                              just = "right",
                                              width = unit(2,"cm"),
                                              location = 0.9,
                                              gp = gpar(fontsize=14,col = "black", border = "black")),
                        which = "row")
subclusters_labelled = Heatmap(m, name = "Expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = TRUE,
                                  show_row_dend = TRUE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  left_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(subclusters_labelled, heatmap_legend_side = "bottom")

#############
# Monocytes #
#############

temp_sce = sce_adult_labelled[,sce_adult_labelled$Clusters=='Monocytes']
markers = c('CD16','CD11b','CD45','Foxp3','CD163','CD68','Ki67','HLADR')

marker_expression <- data.frame(t(assay(temp_sce[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(temp_sce)[,"Subcluster"])
colnames(dat) = "Subcluster"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(Subcluster) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(Subcluster) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Subcluster

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = ","),
                                              which = "row",
                                              rot = 0,
                                              just = "right",
                                              width = unit(2,"cm"),
                                              location = 0.9,
                                              gp = gpar(fontsize=14,col = "black", border = "black")),
                        which = "row")
subclusters_labelled = Heatmap(m, name = "Expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = TRUE,
                                  show_row_dend = TRUE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  left_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(subclusters_labelled, heatmap_legend_side = "bottom")


###############
# Hepatocytes #
###############

temp_sce = sce_adult_labelled[,sce_adult_labelled$Clusters=='Hepatocytes']
markers = c('Ki67','HLADR')

marker_expression <- data.frame(t(assay(temp_sce[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(temp_sce)[,"Subcluster"])
colnames(dat) = "Subcluster"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(Subcluster) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(Subcluster) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Subcluster

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = ","),
                                              which = "row",
                                              rot = 0,
                                              just = "right",
                                              width = unit(2,"cm"),
                                              location = 0.9,
                                              gp = gpar(fontsize=14,col = "black", border = "black")),
                        which = "row")
subclusters_labelled = Heatmap(m, name = "Expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = TRUE,
                                  show_row_dend = TRUE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  left_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(subclusters_labelled, heatmap_legend_side = "bottom")

##################
# Cholangiocytes #
##################

temp_sce = sce_adult_labelled[,sce_adult_labelled$Clusters=='Cholangiocytes']
markers = c('CK7','Ki67','HLADR')

marker_expression <- data.frame(t(assay(temp_sce[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(temp_sce)[,"Subcluster"])
colnames(dat) = "Subcluster"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(Subcluster) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(Subcluster) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Subcluster

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = ","),
                                              which = "row",
                                              rot = 0,
                                              just = "right",
                                              width = unit(2,"cm"),
                                              location = 0.9,
                                              gp = gpar(fontsize=14,col = "black", border = "black")),
                        which = "row")
subclusters_labelled = Heatmap(m, name = "Expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = TRUE,
                                  show_row_dend = TRUE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  left_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(subclusters_labelled, heatmap_legend_side = "bottom")

#####################
# Endothelial cells #
#####################

temp_sce = sce_adult_labelled[,sce_adult_labelled$Clusters=='Endothelial cells']
markers = c('CD31','Ki67','HLADR')

marker_expression <- data.frame(t(assay(temp_sce[markers,], "exprs")))
marker_expression$cellID <- rownames(marker_expression)
dat <- data.frame(colData(temp_sce)[,"Subcluster"])
colnames(dat) = "Subcluster"
dat$cellID <- rownames(marker_expression)
dat <- left_join(dat, marker_expression)
dat$cellID <- NULL
head(dat)

dat_aggr <- dat %>%
  group_by(Subcluster) %>%
  summarise_all(funs(median))

dat_sum <- dat %>%
  group_by(Subcluster) %>%
  dplyr::summarise(n=n())

dat_sum <- data.frame(t(dat_sum))
m <- as.matrix((dat_aggr[,-c(1)]))
rownames(m) <- dat_aggr$Subcluster

ha <- HeatmapAnnotation("Numbers" = anno_text(format(round(as.numeric(dat_sum[2,])),
                                                     nsmall = 0, big.mark = ","),
                                              which = "row",
                                              rot = 0,
                                              just = "right",
                                              width = unit(2,"cm"),
                                              location = 0.9,
                                              gp = gpar(fontsize=14,col = "black", border = "black")),
                        which = "row")
subclusters_labelled = Heatmap(m, name = "Expression",border='black',
                                  cluster_columns = FALSE,
                                  show_column_dend = FALSE,
                                  cluster_rows = TRUE,
                                  show_row_dend = TRUE,
                                  column_names_rot = 90,
                                  column_names_centered = FALSE,
                                  show_column_names = TRUE,
                                  row_title_gp = gpar(fontsize = 23),
                                  left_annotation = ha,
                                  col = colorRamp2(c(0, 2), c("white", "red")),
                                  heatmap_legend_param = list(at = c(0:2), legend_width = unit(3,"cm"),
                                                              direction="horizontal", title_gp = gpar(fontsize=16),
                                                              title_position = "topcenter",
                                                              labels_gp = gpar(fontsize=12)),
                                  column_names_side = "bottom",
                                  height = unit(8, "cm"),
                                  width = unit(20,"cm"))

draw(subclusters_labelled, heatmap_legend_side = "bottom")
```

Export object

```{r}
exportSCE(sce_adult_labelled, samplename = "methods_preprocessed_data", directory = "./", type = "Cells", format = "SCE")
```
